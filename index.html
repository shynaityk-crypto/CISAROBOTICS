<!doctype html>
<html lang="en" data-color-mode="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ArcheoHub ‚Äî Global Archaeological Collaboration Platform</title>

  <!-- Primer CSS -->
  <link rel="stylesheet" href="https://unpkg.com/@primer/css@^21.0.0/dist/primer.css">

  <!-- Leaflet for maps -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- noUiSlider for timeline -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.0/nouislider.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.0/nouislider.min.js"></script>

  <!-- Three.js for 3D stratigraphy viewer -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

  <style>
    :root { 
      --accent-primary: #238636; 
      --accent-secondary: #58a6ff;
      --muted: #8b949e; 
      --bg-primary: #0d1117;
      --bg-secondary: #161b22;
      --border: #30363d;
      --text-primary: #c9d1d9;
      --text-bright: #f0f6fc;
      --danger: #da3633;
      --warning: #d29922;
      --success: #2da44e;
      --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    * { box-sizing: border-box; }
    
    body { 
      background-color: var(--bg-primary);
      color: var(--text-primary);
      font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Helvetica,Arial,sans-serif;
      margin: 0;
      padding: 0;
    }
    
    /* Enhanced Header */
    header.Header { 
      background: linear-gradient(180deg, var(--bg-secondary) 0%, rgba(22,27,34,0.95) 100%);
      border-bottom: 1px solid var(--border);
      backdrop-filter: blur(10px);
      position: sticky;
      top: 0;
      z-index: 1000;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }
    
    .brand { 
      font-weight: 800;
      font-size: 1.25rem;
      margin-right: 16px;
      background: linear-gradient(135deg, #58a6ff 0%, #238636 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      letter-spacing: -0.5px;
    }
    
    .Header-link { 
      color: var(--text-primary);
      margin-right: 16px;
      padding: 8px 12px;
      border-radius: 6px;
      transition: var(--transition);
      font-weight: 500;
    }
    
    .Header-link:hover { 
      color: var(--text-bright);
      background: rgba(88,166,255,0.1);
      text-decoration: none;
    }
    
    /* Enhanced Form Controls */
    .form-control.input-contrast, .form-select { 
      background: var(--bg-primary);
      color: var(--text-primary);
      border: 1px solid var(--border);
      border-radius: 6px;
      transition: var(--transition);
    }
    
    .form-control:focus, .form-select:focus {
      border-color: var(--accent-secondary);
      outline: none;
      box-shadow: 0 0 0 3px rgba(88,166,255,0.1);
    }
    
    /* Enhanced Box Component */
    .Box { 
      background: var(--bg-primary);
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
      transition: var(--transition);
    }
    
    .Box:hover {
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    
    .Box-row { 
      border-top: 1px solid var(--border);
      padding: 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: var(--transition);
    }
    
    .Box-row:first-child { border-top: 0; }
    
    .Box-row:hover {
      background: rgba(88,166,255,0.03);
    }
    
    .Box-title { 
      color: var(--text-bright);
      padding: 16px;
      font-size: 1.1rem;
      font-weight: 600;
      border-bottom: 1px solid var(--border);
    }
    
    /* Enhanced Labels */
    .Label { 
      font-size: 12px;
      padding: 4px 10px;
      border-radius: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }
    
    .Label--orange { background: #6f4a2e; color: #fff; }
    .Label--blue { background: #0969da; color: #fff; }
    .Label--green { background: var(--success); color: #fff; }
    .Label--purple { background: #8250df; color: #fff; }
    .Label--red { background: var(--danger); color: #fff; }
    .Label--yellow { background: var(--warning); color: #000; }
    
    /* Enhanced Buttons */
    .btn {
      border-radius: 6px;
      font-weight: 500;
      transition: var(--transition);
      cursor: pointer;
    }
    
    .btn-primary { 
      background: var(--accent-primary);
      border-color: var(--accent-primary);
      color: #fff;
    }
    
    .btn-primary:hover {
      background: #2ea043;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(46,160,67,0.3);
    }
    
    .btn-ghost { 
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text-primary);
    }
    
    .btn-ghost:hover {
      background: rgba(88,166,255,0.1);
      border-color: var(--accent-secondary);
    }
    
    /* Footer */
    footer.footer { 
      color: var(--muted);
      border-top: 1px solid var(--border);
      padding: 32px 0;
      margin-top: 64px;
      background: var(--bg-secondary);
    }
    
    /* Layout */
    .container-lg { 
      max-width: 1280px;
      margin: 0 auto;
      padding: 24px;
    }
    
    .two-col { 
      display: grid;
      grid-template-columns: 1fr 380px;
      gap: 24px;
    }
    
    @media (max-width:1000px){ 
      .two-col { 
        grid-template-columns: 1fr;
      }
    }
    
    /* Enhanced Map */
    #map { 
      height: 600px;
      border-radius: 12px;
      border: 1px solid var(--border);
      box-shadow: 0 4px 16px rgba(0,0,0,0.3);
    }
    
    /* Repository Cards */
    .repo-card {
      transition: var(--transition);
      cursor: pointer;
    }
    
    .repo-card:hover {
      transform: translateX(4px);
    }
    
    .repo-title { 
      font-weight: 700;
      color: var(--accent-secondary);
      font-size: 1.05rem;
    }
    
    .repo-title:hover {
      text-decoration: underline;
    }
    
    .muted { color: var(--muted); }
    .text-bright { color: var(--text-bright); }
    
    /* Stats Cards */
    .stat-card {
      background: linear-gradient(135deg, rgba(88,166,255,0.1) 0%, rgba(35,134,54,0.1) 100%);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
      text-align: center;
      transition: var(--transition);
    }
    
    .stat-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(88,166,255,0.2);
    }
    
    .stat-number {
      font-size: 2.5rem;
      font-weight: 800;
      background: linear-gradient(135deg, #58a6ff 0%, #238636 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .stat-label {
      font-size: 0.9rem;
      color: var(--muted);
      margin-top: 8px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    
    /* Timeline */
    #timeline { margin-top: 16px; }
    
    .noUi-connect {
      background: linear-gradient(90deg, var(--accent-secondary) 0%, var(--accent-primary) 100%);
    }
    
    /* Modal Overlay */
    .overlay { 
      position: fixed;
      left: 0;
      top: 0;
      right: 0;
      bottom: 0;
      background: rgba(2,6,23,0.92);
      backdrop-filter: blur(4px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 12000;
      animation: fadeIn 0.2s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    .card-dark { 
      background: var(--bg-primary);
      border: 1px solid var(--border);
      color: var(--text-primary);
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.5);
      animation: slideUp 0.3s ease;
    }
    
    @keyframes slideUp {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    
    /* Tabs */
    .tabs { 
      display: flex;
      border-bottom: 2px solid var(--border);
      padding: 0;
    }
    
    .tabs .tab { 
      cursor: pointer;
      padding: 12px 20px;
      border-radius: 6px 6px 0 0;
      margin: 0 4px -2px 0;
      font-weight: 500;
      transition: var(--transition);
      border-bottom: 2px solid transparent;
    }
    
    .tabs .tab:hover {
      background: rgba(88,166,255,0.05);
    }
    
    .tabs .tab.selected { 
      background: rgba(88,166,255,0.1);
      border-bottom-color: var(--accent-secondary);
      color: var(--text-bright);
    }
    
    /* Contribution List */
    .contrib-list { display: grid; gap: 12px; }
    
    /* Form Styling */
    .form-compact label {
      display: block;
      margin-bottom: 12px;
      font-weight: 500;
    }
    
    .form-compact input,
    .form-compact textarea,
    .form-compact select {
      width: 100%;
      box-sizing: border-box;
      margin-top: 6px;
    }
    
    /* Toast Notifications */
    #toast { 
      position: fixed;
      right: 24px;
      bottom: 24px;
      z-index: 14000;
    }
    
    .toast-item {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 16px 20px;
      margin-bottom: 12px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.4);
      animation: slideInRight 0.3s ease;
      min-width: 300px;
    }
    
    @keyframes slideInRight {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    
    /* Loading Spinner */
    .spinner {
      border: 3px solid var(--border);
      border-top: 3px solid var(--accent-secondary);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* Badge */
    .badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      background: rgba(88,166,255,0.2);
      color: var(--accent-secondary);
    }
    
    /* Search Highlight */
    .search-highlight {
      background: rgba(210,153,34,0.2);
      padding: 2px 4px;
      border-radius: 3px;
    }
    
    /* Responsive adjustments */
    @media (max-width: 768px) {
      .brand { font-size: 1rem; }
      .stat-number { font-size: 2rem; }
      #map { height: 400px; }
    }
  </style>
</head>
<body>

<header class="Header d-flex flex-justify-between flex-items-center p-3">
  <div class="d-flex flex-items-center">
    <a class="brand" href="#" data-route="explore">üèõÔ∏è ArcheoHub</a>
    <div class="d-none d-md-block">
      <a class="Header-link" href="#" data-route="explore">Explore</a>
      <a class="Header-link" href="#" data-route="map">Global Map</a>
      <a class="Header-link" href="#" data-route="issues">Issues</a>
      <a class="Header-link" href="#" data-route="prs">Pull Requests</a>
    </div>
  </div>

  <div style="flex:1; margin:0 16px; max-width: 600px;">
    <input id="global-search" type="search" class="form-control input-contrast header-search-input" placeholder="üîç Search sites, repos, commits..." aria-label="Search" />
  </div>

  <div class="d-flex flex-items-center gap-2">
    <button id="theme-toggle" class="btn btn-ghost btn-sm" title="Toggle theme">üåó</button>
    <button id="new-finding-btn" class="btn btn-primary btn-sm">+ New Finding</button>

    <details class="details-reset details-overlay" style="margin-left:8px;">
      <summary id="avatar-summary" class="Header-link" aria-haspopup="menu" role="button" style="cursor: pointer;">
        <img id="avatar-img" class="avatar avatar-user" src="https://avatars.githubusercontent.com/u/0?v=4" width="32" height="32" alt="@guest">
      </summary>
      <div class="dropdown-menu dropdown-menu-sw mt-2" style="width:260px;">
        <div class="dropdown-header">Signed in as <strong id="user-email">guest</strong></div>
        <a class="dropdown-item" href="#" data-route="profile">Your Profile</a>
        <a class="dropdown-item" href="#" id="logout-btn">Sign Out</a>
      </div>
    </details>
  </div>
</header>

<div class="container-lg">
  <div id="app-root"></div>
</div>

<!-- New Finding Modal -->
<div id="new-finding-modal" class="overlay" hidden>
  <div class="card-dark" style="width:720px; max-width:95%;">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h3 style="margin:0">üìã New Archaeological Finding</h3>
      <button id="close-new-finding" class="btn btn-ghost btn-sm">‚úï</button>
    </div>
    
    <form id="new-finding-form" class="form-compact">
      <div class="d-flex gap-2">
        <input name="repo" placeholder="Repository path (e.g. asia/kazakhstan/tamgaly)" class="form-control form-control-sm" required />
        <select name="type" class="form-select form-select-sm" style="width:180px;">
          <option>Discovery</option>
          <option>Analysis</option>
          <option>Theory</option>
          <option>Preservation</option>
          <option>Maintenance</option>
        </select>
      </div>
      
      <div class="mt-2">
        <input name="title" placeholder="Title of finding" class="form-control form-control-sm" required />
      </div>

      <div class="mt-2">
        <input name="submitterEmail" placeholder="Your email (optional)" class="form-control form-control-sm" />
      </div>

      <div class="mt-2">
        <textarea name="desc" placeholder="Description" class="form-control form-control-sm" rows="5"></textarea>
      </div>
      
      <div class="mt-3 d-flex justify-content-end gap-2">
        <button type="button" id="submit-finding" class="btn btn-primary">Submit Finding</button>
      </div>
    </form>

    <hr style="margin:16px 0; border-color:var(--border);">
    
    <div style="margin-top:12px;">
      <div style="font-weight:700; margin-bottom:8px;">üìß Send Direct Message</div>
      <form action="https://formspree.io/f/xdakdvqo" method="POST" class="form-compact" target="_blank">
        <label>
          Your email:
          <input type="email" name="email" class="form-control form-control-sm" />
        </label>
        <label>
          Your message:
          <textarea name="message" class="form-control form-control-sm" rows="4"></textarea>
        </label>
        <input type="hidden" name="_subject" value="ArcheoHub ‚Äî New finding (direct form)" />
        <div style="margin-top:12px; text-align:right;">
          <button type="submit" class="btn btn-ghost">Send via Formspree</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Auth Modal -->
<div id="auth-modal" class="overlay" hidden>
  <div class="card-dark" style="width:420px; max-width:95%;">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h3 style="margin:0" id="auth-title">üîê Sign In</h3>
      <button id="auth-close" class="btn btn-ghost btn-sm">‚úï</button>
    </div>
    <div>
      <div class="mb-2 small muted" id="auth-note">Use any email address for demo sign-in (local only).</div>
      <input id="auth-email" class="form-control form-control-sm mb-2" placeholder="you@email.com" />
      <input id="auth-name" class="form-control form-control-sm mb-2" placeholder="Display name (optional)" />
      <div class="d-flex justify-content-end gap-2 mt-3">
        <button id="auth-submit" class="btn btn-primary">Sign In</button>
      </div>
    </div>
  </div>
</div>

<!-- Toast Container -->
<div id="toast"></div>

<footer class="footer mt-5">
  <div class="container-lg text-center">
    <p class="mb-0">¬© 2026 ArcheoHub ‚Äî Global Archaeological Collaboration Platform</p>
    <p class="small muted">Contact: <a href="mailto:shyn.aityk@gmail.com" style="color: var(--accent-secondary);">shyn.aityk@gmail.com</a></p>
  </div>
</footer>

<script>
/* ============================================================================
   ARCHEOHUB - ENHANCED GLOBAL ARCHAEOLOGICAL PLATFORM
   
   Core Features:
   - Global archaeological site database with Kazakhstan focus
   - Interactive mapping with Leaflet
   - Git-like version control for excavation data
   - 3D stratigraphy visualization with Three.js
   - Issue tracking and pull requests
   - Timeline filtering and data export
   ============================================================================ */

// ============================================================================
// UTILITY FUNCTIONS
// ============================================================================

/**
 * Generate unique identifier with prefix
 * @param {string} prefix - Prefix for the ID
 * @returns {string} Unique ID
 */
function uid(prefix='id'){ 
  return prefix + '-' + Math.random().toString(36).slice(2,11) + Date.now().toString(36);
}

/**
 * Get current ISO timestamp
 * @returns {string} ISO timestamp
 */
function now(){ 
  return new Date().toISOString();
}

/**
 * Save data to localStorage with error handling
 * @param {string} key - Storage key
 * @param {*} value - Value to store
 */
function saveLS(key, value){ 
  try { 
    localStorage.setItem(key, JSON.stringify(value));
  } catch(e){ 
    console.warn('localStorage save error:', e);
    toast('‚ö†Ô∏è Storage limit reached', 3000);
  }
}

/**
 * Load data from localStorage with fallback
 * @param {string} key - Storage key
 * @param {*} fallback - Fallback value
 * @returns {*} Stored value or fallback
 */
function loadLS(key, fallback){ 
  try{ 
    const v = localStorage.getItem(key);
    return v ? JSON.parse(v) : fallback;
  } catch(e){ 
    console.warn('localStorage load error:', e);
    return fallback;
  }
}

/**
 * Display toast notification
 * @param {string} msg - Message to display
 * @param {number} ms - Duration in milliseconds
 */
function toast(msg, ms=3000){ 
  const t = document.createElement('div');
  t.className = 'toast-item';
  t.textContent = msg;
  document.getElementById('toast').appendChild(t);
  setTimeout(() => {
    t.style.animation = 'slideInRight 0.3s ease reverse';
    setTimeout(() => t.remove(), 300);
  }, ms);
}

/**
 * Safely attach event listener
 * @param {string|HTMLElement} target - Element or selector
 * @param {string} event - Event name
 * @param {Function} handler - Event handler
 */
function safeOn(target, event, handler){
  if(!target) return;
  let el = typeof target === 'string' ? document.querySelector(target) : target;
  if(el && typeof el.addEventListener === 'function') {
    el.addEventListener(event, handler);
  }
}

/**
 * Escape HTML to prevent XSS
 * @param {string} s - String to escape
 * @returns {string} Escaped string
 */
function escapeHTML(s){
  if (s === null || s === undefined) return '';
  return String(s)
    .replace(/&/g,'&amp;')
    .replace(/</g,'&lt;')
    .replace(/>/g,'&gt;')
    .replace(/"/g,'&quot;')
    .replace(/'/g,'&#039;');
}

/**
 * Format number with commas
 * @param {number} num - Number to format
 * @returns {string} Formatted number
 */
function formatNumber(num) {
  return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
}

// ============================================================================
// FORMSPREE INTEGRATION
// ============================================================================

const FORMSPREE_ENDPOINT = 'https://formspree.io/f/xdakdvqo';

/**
 * Send finding data to Formspree
 * @param {Object} payload - Finding data
 * @returns {Promise<Object>} Response object
 */
async function sendFindingToFormspree(payload){
  try {
    const res = await fetch(FORMSPREE_ENDPOINT, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Accept': 'application/json'
      },
      body: JSON.stringify({
        email: payload.email || '',
        repo: payload.repoPath,
        type: payload.type,
        title: payload.title,
        message: payload.desc,
        author: payload.author,
        time: payload.time,
        _subject: `ArcheoHub ‚Äî New finding: ${payload.title}`,
        _replyto: payload.email || ''
      })
    });
    
    if(res.ok) return { ok: true };
    
    const text = await res.text().catch(() => null);
    console.warn('Formspree response not ok', res.status, text);
    return { ok: false, status: res.status, text };
  } catch(err){
    console.error('sendFindingToFormspree error', err);
    return { ok: false, error: String(err) };
  }
}

// ============================================================================
// APPLICATION STATE
// ============================================================================

const App = {
  theme: localStorage.getItem('theme') || 'dark',
  user: loadLS('archeo_user', null),
  repos: loadLS('archeo_repos', null),
  issues: loadLS('archeo_issues', null),
  prs: loadLS('archeo_prs', null),
  page: 'explore',
  currentRepoId: null,
  filter: { 
    type: '', 
    search: '', 
    yearRange: [-10000, 2026],
    region: ''
  }
};

document.documentElement.setAttribute('data-color-mode', App.theme);

// ============================================================================
// DATA SEEDING - COMPREHENSIVE GLOBAL ARCHAEOLOGICAL SITES
// ============================================================================

if(!App.repos){
  App.repos = [];
  
  /**
   * Comprehensive global archaeological sites database
   * Format: [Name, Country, Region, Lat, Lon, Period, Description]
   */
  const GLOBAL_SITES = [
    // KAZAKHSTAN (Central Asia)
    ["Tamgaly Petroglyphs", "Kazakhstan", "Central Asia", 43.8056, 75.5386, "Bronze Age", "UNESCO World Heritage petroglyphs from 2nd millennium BCE"],
    ["Otrar Ancient City", "Kazakhstan", "Central Asia", 42.9000, 68.3167, "Medieval", "Major Silk Road city, birthplace of Al-Farabi"],
    ["Bozok Ancient Settlement", "Kazakhstan", "Central Asia", 51.1801, 71.4460, "Medieval", "Medieval settlement near modern Astana"],
    ["Taraz Archaeological Complex", "Kazakhstan", "Central Asia", 42.9000, 71.3667, "Medieval", "Ancient Silk Road city dating to 6th century"],
    ["Almaty Kurgan Burial Mounds", "Kazakhstan", "Central Asia", 43.2220, 76.8512, "Iron Age", "Scythian-Saka burial mounds"],
    ["Berel Burial Mounds", "Kazakhstan", "Central Asia", 49.3333, 86.0833, "Iron Age", "Scythian royal burials with preserved horses"],
    ["Issyk Kurgan", "Kazakhstan", "Central Asia", 43.3500, 77.4333, "Iron Age", "Golden Warrior discovery site"],
    ["Akyrtas Palace Complex", "Kazakhstan", "Central Asia", 42.7833, 73.6167, "Medieval", "Mysterious medieval palace ruins"],
    ["Sauran Fortress", "Kazakhstan", "Central Asia", 42.3167, 68.6500, "Medieval", "Medieval fortress on the Silk Road"],
    ["Merke Settlement", "Kazakhstan", "Central Asia", 42.8833, 73.1667, "Bronze Age", "Bronze Age settlement"],
    
    // EGYPT
    ["Giza Plateau", "Egypt", "Africa", 29.9792, 31.1342, "Old Kingdom", "Great Pyramids and Sphinx complex"],
    ["Valley of the Kings", "Egypt", "Africa", 25.7402, 32.6014, "New Kingdom", "Royal tombs including Tutankhamun"],
    ["Karnak Temple Complex", "Egypt", "Africa", 25.7188, 32.6573, "Middle Kingdom", "Largest ancient religious site"],
    ["Abu Simbel", "Egypt", "Africa", 22.3372, 31.6258, "New Kingdom", "Rock temples of Ramesses II"],
    ["Saqqara Necropolis", "Egypt", "Africa", 29.8711, 31.2169, "Old Kingdom", "Step Pyramid of Djoser"],
    
    // ITALY
    ["Pompeii", "Italy", "Europe", 40.7460, 14.4989, "Roman", "Preserved Roman city from 79 CE eruption"],
    ["Roman Forum", "Italy", "Europe", 41.8925, 12.4853, "Roman", "Center of ancient Rome"],
    ["Herculaneum", "Italy", "Europe", 40
