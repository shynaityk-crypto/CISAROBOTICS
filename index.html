<!doctype html>
<html lang="en" data-color-mode="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ArcheoHub ‚Äî Git for Archaeology (Kazakhstan Edition)</title>

  <link rel="stylesheet" href="https://unpkg.com/@primer/css@^21.0.0/dist/primer.css">

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <link href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.0/nouislider.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.0/nouislider.min.js"></script>

  <script src="https://unpkg.com/three@0.152.2/build/three.min.js"></script>

  <style>
    /* Basic visual adjustments on top of Primer to make it feel GitHub-like */
    :root { --accent: #238636; --muted: #8b949e; }
    body { background-color: #0d1117; color: #c9d1d9; font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Helvetica,Arial,sans-serif; }
    header.Header { background-color:#161b22; border-bottom:1px solid #30363d; }
    .brand { font-weight:700; font-size:1.15rem; margin-right:12px; color:#f0f6fc; }
    .Header-link { color:#c9d1d9; margin-right:12px; }
    .Header-link:hover { color:#fff; }
    .form-control.input-contrast, .form-select { background:#0d1117; color:#c9d1d9; border:1px solid #30363d; }
    .Box { background:#0d1117; border:1px solid #30363d; border-radius:8px; }
    .Box-row { border-top:1px solid #30363d; padding:12px; display:flex; justify-content:space-between; align-items:center; }
    .Box-row:first-child { border-top:0; }
    .Box-title { color:#c9d1d9; padding:12px; font-size:1.05rem; }
    .Label { font-size:12px; padding:4px 8px; border-radius:6px; }
    .Label--orange { background:#6f4a2e; color:#fff; }
    .Label--blue { background:#0366d6; color:#fff; }
    .Label--green { background:#2da44e; color:#fff; }
    .btn-primary { background:var(--accent); border-color:var(--accent); color:#fff; }
    footer.footer { color:var(--muted); border-top:1px solid #30363d; padding:24px 0; }
    /* layout */
    .container-lg { max-width:1200px; margin:0 auto; padding:20px; }
    .two-col { display:grid; grid-template-columns: 1fr 360px; gap:20px; }
    @media (max-width:1000px){ .two-col { grid-template-columns: 1fr; } .panel-right { position:static; } }
    /* map */
    #map { height:520px; border-radius:8px; border:1px solid #30363d; }
    /* repo list */
    .repo-title { font-weight:700; color:#58a6ff; }
    .muted { color:var(--muted); }
    /* timeline */
    #timeline { margin-top:12px; }
    /* modal overlay */
    .overlay { position:fixed; left:0; top:0; right:0; bottom:0; background: rgba(2,6,23,0.85); display:flex; align-items:center; justify-content:center; z-index:12000; }
    .card-dark { background:#0d1117; border:1px solid #30363d; color:#c9d1d9; border-radius:10px; padding:16px; }
    /* small responsive tweaks */
    .small { font-size:13px; }
    .btn-ghost { background: transparent; border: 1px solid rgba(255,255,255,0.04); color: #c9d1d9; }
    /* tabs */
    .tabs .tab { cursor:pointer; border-radius:6px; margin-right:6px; }
    .tabs .tab.selected { background: rgba(88,166,255,0.08); }
    /* contribution list */
    .contrib-list { display:grid; gap:8px; }
    .form-compact label{display:block;margin-bottom:8px;}
    .form-compact input,.form-compact textarea,.form-compact select{width:100%;box-sizing:border-box;margin-top:4px;}
  </style>
</head>
<body>

<header class="Header d-flex flex-justify-between flex-items-center p-3">
  <div class="d-flex flex-items-center">
    <a class="brand">ArcheoHub</a>
    <div class="d-none d-md-block">
      <a class="Header-link" href="#" data-route="explore">Explore</a>
      <a class="Header-link" href="#" data-route="map">Map</a>
      <a class="Header-link" href="#" data-route="issues">Issues</a>
      <a class="Header-link" href="#" data-route="prs">Pull requests</a>
    </div>
  </div>

  <div style="flex:1; margin:0 16px;">
    <input id="global-search" type="search" class="form-control input-contrast header-search-input" placeholder="Search sites in Kazakhstan, Giza, etc‚Ä¶" aria-label="Search" />
  </div>

  <div class="d-flex flex-items-center gap-2">
    <button id="theme-toggle" class="btn btn-ghost btn-sm" title="Toggle theme">üåó</button>
    <button id="new-finding-btn" class="btn btn-primary btn-sm">+ New finding</button>

    <details class="details-reset details-overlay" style="margin-left:8px;">
      <summary id="avatar-summary" class="Header-link" aria-haspopup="menu" role="button">
        <img id="avatar-img" class="avatar avatar-user" src="https://avatars.githubusercontent.com/u/0?v=4" width="32" height="32" alt="@guest">
      </summary>
      <div class="dropdown-menu dropdown-menu-sw mt-2" style="width:260px;">
        <div class="dropdown-header">Signed in as <strong id="user-email">guest</strong></div>
        <a class="dropdown-item" href="#" data-route="profile">Your profile</a>
        <a class="dropdown-item" href="#" id="logout-btn">Sign out</a>
      </div>
    </details>
  </div>
</header>

<div class="container-lg">
  <div class="d-flex flex-justify-between mb-4">
    <div>
      <h1 class="f1 text-normal">ArcheoHub ‚Äî Kazakhstan & Global Heritage</h1>
      <p class="muted small">Explore archaeological sites, stratigraphy, and research. Data is local & simulated for this prototype.</p>
    </div>
    <div class="d-none d-md-flex flex-items-center gap-2">
      <select id="filter-type" class="form-select form-select-sm">
        <option value="">All commit types</option>
        <option>Discovery</option>
        <option>Analysis</option>
        <option>Theory</option>
        <option>Preservation</option>
        <option>Maintenance</option>
      </select>
      <button id="open-explore" class="btn btn-ghost btn-sm">Explore</button>
    </div>
  </div>

  <div id="app-root"></div>
</div>

<div id="new-finding-modal" class="overlay" hidden>
  <div class="card-dark" style="width:720px; max-width:95%;">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h3 style="margin:0">New Archaeological Finding</h3>
      <button id="close-new-finding" class="btn btn-ghost btn-sm">Close</button>
    </div>
    <form id="new-finding-form" class="form-compact">
      <div class="d-flex gap-2">
        <input name="repo" placeholder="Repository path (e.g. kazakhstan/almaty/tamgaly)" class="form-control form-control-sm" required />
        <select name="type" class="form-select form-select-sm" style="width:180px;">
          <option>Discovery</option>
          <option>Analysis</option>
          <option>Theory</option>
          <option>Preservation</option>
          <option>Maintenance</option>
        </select>
      </div>
      <div class="mt-2"><input name="title" placeholder="Title" class="form-control form-control-sm" required /></div>
      <div class="mt-2">
        <input name="submitterEmail" placeholder="Your email (optional)" class="form-control form-control-sm" />
      </div>
      <div class="mt-2"><textarea name="desc" placeholder="Description" class="form-control form-control-sm" rows="5"></textarea></div>
      <div class="mt-2 d-flex justify-content-end gap-2">
        <button type="button" id="submit-finding" class="btn btn-primary">Submit</button>
      </div>
    </form>
    <hr style="margin:12px 0; border-color:#30363d;">
    <div style="margin-top:8px;">
      <div style="font-weight:700; margin-bottom:8px;">Direct Submission (Formspree)</div>
      <form action="https://formspree.io/f/xdakdvqo" method="POST" class="form-compact" target="_blank">
        <label>Email: <input type="email" name="email" class="form-control form-control-sm" /></label>
        <label>Message: <textarea name="message" class="form-control form-control-sm" rows="4"></textarea></label>
        <input type="hidden" name="_subject" value="ArcheoHub ‚Äî New finding (direct form)" />
        <div style="margin-top:8px; text-align:right;">
          <button type="submit" class="btn btn-ghost">Send via Formspree</button>
        </div>
      </form>
    </div>
  </div>
</div>

<div id="auth-modal" class="overlay" hidden>
  <div class="card-dark" style="width:420px; max-width:95%;">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h3 style="margin:0" id="auth-title">Sign in</h3>
      <button id="auth-close" class="btn btn-ghost btn-sm">Close</button>
    </div>
    <div>
      <input id="auth-email" class="form-control form-control-sm mb-2" placeholder="you@gmail.com" />
      <input id="auth-name" class="form-control form-control-sm mb-2" placeholder="Display name" />
      <div class="d-flex justify-content-end gap-2">
        <button id="auth-submit" class="btn btn-primary">Sign in</button>
      </div>
    </div>
  </div>
</div>

<div id="toast" style="position:fixed; right:18px; bottom:18px; z-index:14000;"></div>

<footer class="footer mt-5">
  <div class="container-lg text-center">
    <p class="mb-0">¬© 2026 ArcheoHub ‚Äî Kazakhstan Focus. Contact: <a href="mailto:shyn.aityk@gmail.com">shyn.aityk@gmail.com</a></p>
  </div>
</footer>

<script>
/* Helpers */
function uid(prefix='id'){ return prefix + '-' + Math.random().toString(36).slice(2,9); }
function now(){ return new Date().toISOString(); }
function saveLS(key,value){ try { localStorage.setItem(key, JSON.stringify(value)); } catch(e){}}
function loadLS(key, fallback){ try{ const v = localStorage.getItem(key); return v ? JSON.parse(v) : fallback; }catch(e){ return fallback; } }
function toast(msg, ms=2500){ const t=document.createElement('div'); t.className='Box p-2 mb-2'; t.style.background='#0b1220'; t.textContent=msg; document.getElementById('toast').appendChild(t); setTimeout(()=> t.remove(), ms); }
function escapeHTML(s){ return String(s || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function safeOn(target, event, handler){
  let el = typeof target === 'string' ? document.querySelector(target) : target;
  if(el) el.addEventListener(event, handler);
}

/* Formspree Integration */
const FORMSPREE_ENDPOINT = 'https://formspree.io/f/xdakdvqo';
async function sendFindingToFormspree(payload){
  try {
    const res = await fetch(FORMSPREE_ENDPOINT, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
      body: JSON.stringify({ ...payload, _subject: `ArcheoHub Finding: ${payload.title}` })
    });
    return { ok: res.ok };
  } catch(err){ return { ok: false }; }
}

/* State Management */
const App = {
  theme: localStorage.getItem('theme') || 'dark',
  user: loadLS('archeo_user', null),
  repos: loadLS('archeo_repos', null),
  issues: loadLS('archeo_issues', null),
  prs: loadLS('archeo_prs', null),
  page: 'explore',
  currentRepoId: null,
  filter: { type: '', search: '', yearRange: [-3000, 2020] }
};

document.documentElement.setAttribute('data-color-mode', App.theme);

/* Seeding with Kazakhstan Findings */
if(!App.repos){
  App.repos = [];
  const BASE = [
    ["Tamgaly Petroglyphs", "Kazakhstan", 43.8033, 75.5358],
    ["Otrar City Ruins", "Kazakhstan", 42.8522, 68.3025],
    ["Bozok Settlement", "Kazakhstan", 51.1086, 71.3005],
    ["Issyk Kurgan (Golden Man)", "Kazakhstan", 43.3951, 77.4011],
    ["Berel Mounds", "Kazakhstan", 49.3758, 86.4317],
    ["Akyrtas Palace", "Kazakhstan", 42.9567, 71.8052],
    ["Kenes Scythian Site", "Kazakhstan", 43.2389, 76.8897],
    ["Giza Plateau","Egypt",29.9792,31.1342],
    ["Pompeii","Italy",40.7460,14.4989],
    ["Stonehenge","UK",51.1789,-1.8262]
  ];

  let rid = 1;
  BASE.forEach((b) => {
    const count = b[1] === "Kazakhstan" ? 3 : 1;
    for(let i=0; i<count; i++){
      const lat = b[2] + (Math.random()-0.5)*0.2;
      const lon = b[3] + (Math.random()-0.5)*0.2;
      const commitCount = Math.floor(Math.random()*5)+2;
      const commits = [];
      for(let c=0; c<commitCount; c++){
        commits.push({
          id: uid('c'), author: "ArcheoHub Seed", year: Math.floor(-1000 + Math.random()*3000), 
          type: "Discovery", message: `Layer documentation for ${b[0]}`,
          layers: [{id: uid('l'), name: "Primary Stratum", thickness: 25, color: "#c2a97f", notes: "Excavation notes"}]
        });
      }
      App.repos.push({
        id: String(rid++), name: i === 0 ? b[0] : `${b[0]} Sector ${i+1}`,
        site: b[0], country: b[1], lat, lon, commits, 
        stars: Math.floor(Math.random()*400), forks: Math.floor(Math.random()*80), owner: 'community'
      });
    }
  });
  saveLS('archeo_repos', App.repos);
}

/* Navigation & Rendering Logic */
function navigate(page, opts={}){
  App.page = page;
  if(opts.repoId) App.currentRepoId = opts.repoId;
  window.location.hash = `#${page}${opts.repoId?'-'+opts.repoId:''}`;
  render();
}

function render(){
  updateHeaderAuth();
  const root = document.getElementById('app-root');
  if(!root) return;
  root.innerHTML = '';
  if(App.page === 'explore') renderExplore(root);
  else if(App.page === 'map') renderMap(root);
  else if(App.page === 'repo') renderRepo(root, App.currentRepoId);
  else if(App.page === 'profile') renderProfile(root);
  else if(App.page === 'issues') renderIssuesBoard(root);
  else if(App.page === 'prs') renderPRList(root);
}

/* Explore View */
function renderExplore(root){
  root.innerHTML = `
    <div class="two-col">
      <div><div class="Box"><div class="Box-title">Explore Sites</div><div id="repo-list"></div></div></div>
      <aside>
        <div class="Box p-3">
          <strong>Site Filters</strong>
          <input id="search-input" class="form-control form-control-sm mt-2" placeholder="Filter by country or name..." value="${App.filter.search}">
          <button id="apply-filter" class="btn btn-sm btn-primary mt-2 w-100">Apply</button>
        </div>
      </aside>
    </div>`;
  const list = document.getElementById('repo-list');
  const filtered = App.repos.filter(r => 
    r.country.toLowerCase().includes(App.filter.search.toLowerCase()) || 
    r.name.toLowerCase().includes(App.filter.search.toLowerCase())
  ).sort((a,b) => b.stars - a.stars);

  list.innerHTML = filtered.map(r => `
    <div class="Box-row">
      <div style="flex:1">
        <div class="repo-title"><a href="#" onclick="navigate('repo',{repoId:'${r.id}'});return false;">${escapeHTML(r.name)}</a></div>
        <div class="small muted">${escapeHTML(r.country)} ‚Ä¢ Lat: ${r.lat.toFixed(2)}</div>
      </div>
      <div class="small">‚òÖ ${r.stars}</div>
    </div>
  `).join('');

  safeOn('#apply-filter','click', () => {
    App.filter.search = document.getElementById('search-input').value;
    renderExplore(root);
  });
}

/* Map View - Focus on Kazakhstan */
function renderMap(root){
  root.innerHTML = `<div class="Box p-3"><h3>Regional Map</h3><div id="map" class="mt-2"></div></div>`;
  if(typeof L === 'undefined') return;
  const map = L.map('map').setView([48.0196, 66.9237], 4); // Focused on Kazakhstan
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

  App.repos.forEach(r => {
    const isKZ = r.country === 'Kazakhstan';
    const marker = L.circleMarker([r.lat, r.lon], {
      radius: 6, color: '#071625', fillColor: isKZ ? '#2da44e' : '#58a6ff', fillOpacity: 0.9
    }).addTo(map);
    marker.bindPopup(`<strong>${r.name}</strong><br>${r.country}<br><button class="btn btn-sm btn-ghost mt-1" onclick="navigate('repo',{repoId:'${r.id}'})">View</button>`);
  });
}

/* Repository View */
function renderRepo(root, id){
  const repo = App.repos.find(r => r.id === id);
  if(!repo) return navigate('explore');
  root.innerHTML = `
    <div class="Box p-3">
      <div class="d-flex justify-content-between">
        <h2 class="repo-title">${escapeHTML(repo.name)}</h2>
        <button class="btn btn-sm btn-ghost" onclick="navigate('explore')">‚Üê Back</button>
      </div>
      <p class="muted">${repo.country} ‚Äî Archaeological Data Repository</p>
      <div class="tabs d-flex mt-3" style="border-bottom:1px solid #30363d;">
        <div class="tab selected p-2">Commits</div>
      </div>
      <div class="mt-3">
        ${repo.commits.map(c => `
          <div class="Box-row">
            <div>
              <strong>${escapeHTML(c.message)}</strong>
              <div class="small muted">${escapeHTML(c.author)} ‚Ä¢ Year ${c.year}</div>
            </div>
            <button class="btn btn-sm btn-ghost" onclick='open3DViewer(${JSON.stringify(repo)}, ${JSON.stringify(c)})'>3D Viewer</button>
          </div>`).join('')}
      </div>
    </div>`;
}

/* Profile and Other views (abbreviated implementations as per previous logic) */
function renderProfile(root){ root.innerHTML = '<div class="Box p-3">Profile View (Demo)</div>'; }
function renderIssuesBoard(root){ root.innerHTML = '<div class="Box p-3">Issues Board (Demo)</div>'; }
function renderPRList(root){ root.innerHTML = '<div class="Box p-3">Pull Requests (Demo)</div>'; }

/* 3D Viewer Logic (Three.js) */
function open3DViewer(repo, commit){
  if(typeof THREE === 'undefined') return alert('Three.js not loaded');
  const overlay = document.createElement('div');
  overlay.className = 'overlay';
  overlay.innerHTML = `<div id="three-modal" style="width:80%; height:80%; background:#0d1117; border-radius:10px; display:flex; flex-direction:column;">
    <div class="p-2 d-flex justify-content-between" style="border-bottom:1px solid #30363d;">
      <strong>${repo.name} 3D View</strong>
      <button class="btn btn-sm btn-ghost" id="close-3d">Close</button>
    </div>
    <div id="canvas-container" style="flex:1;"></div>
  </div>`;
  document.body.appendChild(overlay);
  safeOn('#close-3d','click', () => overlay.remove());

  const container = document.getElementById('canvas-container');
  const scene = new THREE.Scene();
  const camera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000);
  const renderer = new THREE.WebGLRenderer();
  renderer.setSize(container.clientWidth, container.clientHeight);
  container.appendChild(renderer.domElement);

  const geometry = new THREE.BoxGeometry(2, 0.5, 2);
  const material = new THREE.MeshStandardMaterial({ color: 0xc2a97f });
  const cube = new THREE.Mesh(geometry, material);
  scene.add(cube);
  const light = new THREE.PointLight(0xffffff, 1, 100); light.position.set(5, 5, 5); scene.add(light);
  scene.add(new THREE.AmbientLight(0x404040));
  camera.position.z = 5;

  function animate() { requestAnimationFrame(animate); cube.rotation.y += 0.01; renderer.render(scene, camera); }
  animate();
}

/* Event Initialization */
function updateHeaderAuth(){
  const emailEl = document.getElementById('user-email');
  if(App.user) emailEl.textContent = App.user.email;
}

safeOn('#new-finding-btn','click', () => document.getElementById('new-finding-modal').hidden = false);
safeOn('#close-new-finding','click', () => document.getElementById('new-finding-modal').hidden = true);
safeOn('#submit-finding','click', async () => {
  const form = document.getElementById('new-finding-form');
  const payload = { title: form.title.value, repo: form.repo.value, desc: form.desc.value };
  toast('Sending to Formspree...');
  const res = await sendFindingToFormspree(payload);
  if(res.ok) toast('Finding Shared!');
  document.getElementById('new-finding-modal').hidden = true;
});

safeOn('#theme-toggle','click', () => {
  App.theme = App.theme === 'dark' ? 'light' : 'dark';
  document.documentElement.setAttribute('data-color-mode', App.theme);
  localStorage.setItem('theme', App.theme);
});

document.querySelectorAll('[data-route]').forEach(el => {
  el.onclick = (e) => { e.preventDefault(); navigate(el.dataset.route); };
});

/* Initial Boot */
(function init(){
  const h = window.location.hash.slice(1).split('-');
  if(h[0]) App.page = h[0];
  if(h[1]) App.currentRepoId = h[1];
  render();
})();
</script>
</body>
</html>
