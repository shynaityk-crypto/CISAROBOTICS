
–í—ã —Å–∫–∞–∑–∞–ª–∏:
<!doctype html>
<html lang="en" data-color-mode="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ArcheoHub ‚Äî Git for Archaeology (Prototype)</title>

  <!-- Primer CSS (open-source GitHub design system) -->
  <link rel="stylesheet" href="https://unpkg.com/@primer/css@^21.0.0/dist/primer.css">

  <!-- Leaflet for maps -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- noUiSlider for timeline -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.0/nouislider.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.0/nouislider.min.js"></script>

  <!-- Three.js for 3D stratigraphy viewer -->
  <script src="https://unpkg.com/three@0.152.2/build/three.min.js"></script>

  <style>
    /* Basic visual adjustments on top of Primer to make it feel GitHub-like */
    :root { --accent: #238636; --muted: #8b949e; }
    body { background-color: #0d1117; color: #c9d1d9; font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Helvetica,Arial,sans-serif; }
    header.Header { background-color:#161b22; border-bottom:1px solid #30363d; }
    .brand { font-weight:700; font-size:1.15rem; margin-right:12px; color:#f0f6fc; }
    .Header-link { color:#c9d1d9; margin-right:12px; }
    .Header-link:hover { color:#fff; }
    .form-control.input-contrast, .form-select { background:#0d1117; color:#c9d1d9; border:1px solid #30363d; }
    .Box { background:#0d1117; border:1px solid #30363d; border-radius:8px; }
    .Box-row { border-top:1px solid #30363d; padding:12px; display:flex; justify-content:space-between; align-items:center; }
    .Box-row:first-child { border-top:0; }
    .Box-title { color:#c9d1d9; padding:12px; font-size:1.05rem; }
    .Label { font-size:12px; padding:4px 8px; border-radius:6px; }
    .Label--orange { background:#6f4a2e; color:#fff; }
    .Label--blue { background:#0366d6; color:#fff; }
    .Label--green { background:#2da44e; color:#fff; }
    .btn-primary { background:var(--accent); border-color:var(--accent); color:#fff; }
    footer.footer { color:var(--muted); border-top:1px solid #30363d; padding:24px 0; }
    /* layout */
    .container-lg { max-width:1200px; margin:0 auto; padding:20px; }
    .two-col { display:grid; grid-template-columns: 1fr 360px; gap:20px; }
    @media (max-width:1000px){ .two-col { grid-template-columns: 1fr; } .panel-right { position:static; } }
    /* map */
    #map { height:520px; border-radius:8px; border:1px solid #30363d; }
    /* repo list */
    .repo-title { font-weight:700; color:#58a6ff; }
    .muted { color:var(--muted); }
    /* timeline */
    #timeline { margin-top:12px; }
    /* modal overlay */
    .overlay { position:fixed; left:0; top:0; right:0; bottom:0; background: rgba(2,6,23,0.85); display:flex; align-items:center; justify-content:center; z-index:12000; }
    .card-dark { background:#0d1117; border:1px solid #30363d; color:#c9d1d9; border-radius:10px; padding:16px; }
    /* small responsive tweaks */
    .small { font-size:13px; }
    .btn-ghost { background: transparent; border: 1px solid rgba(255,255,255,0.04); color: #c9d1d9; }
    /* tabs */
    .tabs .tab { cursor:pointer; border-radius:6px; margin-right:6px; }
    .tabs .tab.selected { background: rgba(88,166,255,0.08); }
    /* contribution list */
    .contrib-list { display:grid; gap:8px; }
    .form-compact label{display:block;margin-bottom:8px;}
    .form-compact input,.form-compact textarea,.form-compact select{width:100%;box-sizing:border-box;margin-top:4px;}
  </style>
</head>
<body>

<header class="Header d-flex flex-justify-between flex-items-center p-3">
  <div class="d-flex flex-items-center">
    <a class="brand">ArcheoHub</a>
    <div class="d-none d-md-block">
      <a class="Header-link" href="#" data-route="explore">Explore</a>
      <a class="Header-link" href="#" data-route="map">Map</a>
      <a class="Header-link" href="#" data-route="issues">Issues</a>
      <a class="Header-link" href="#" data-route="prs">Pull requests</a>
    </div>
  </div>

  <div style="flex:1; margin:0 16px;">
    <input id="global-search" type="search" class="form-control input-contrast header-search-input" placeholder="Search archaeological sites, repos, or commits‚Ä¶" aria-label="Search" />
  </div>

  <div class="d-flex flex-items-center gap-2">
    <button id="theme-toggle" class="btn btn-ghost btn-sm" title="Toggle theme">üåó</button>
    <button id="new-finding-btn" class="btn btn-primary btn-sm">+ New finding</button>

    <details class="details-reset details-overlay" style="margin-left:8px;">
      <summary id="avatar-summary" class="Header-link" aria-haspopup="menu" role="button">
        <img id="avatar-img" class="avatar avatar-user" src="https://avatars.githubusercontent.com/u/0?v=4" width="32" height="32" alt="@guest">
      </summary>
      <div class="dropdown-menu dropdown-menu-sw mt-2" style="width:260px;">
        <div class="dropdown-header">Signed in as <strong id="user-email">guest</strong></div>
        <a class="dropdown-item" href="#" data-route="profile">Your profile</a>
        <a class="dropdown-item" href="#" id="logout-btn">Sign out</a>
      </div>
    </details>
  </div>
</header>

<!-- Main container -->
<div class="container-lg">
  <!-- top banner / filters -->
  <div class="d-flex flex-justify-between mb-4">
    <div>
      <h1 class="f1 text-normal">ArcheoHub ‚Äî Git for Archaeology</h1>
      <p class="muted small">Explore sites, commits, stratigraphy diffs, issues and pull requests. This is a prototype ‚Äî data is local & simulated.</p>
    </div>
    <div class="d-none d-md-flex flex-items-center gap-2">
      <select id="filter-type" class="form-select form-select-sm">
        <option value="">All commit types</option>
        <option>Discovery</option>
        <option>Analysis</option>
        <option>Theory</option>
        <option>Preservation</option>
        <option>Maintenance</option>
      </select>
      <button id="open-explore" class="btn btn-ghost btn-sm">Explore</button>
    </div>
  </div>

  <!-- SPA render target -->
  <div id="app-root"></div>
</div>

<!-- New Finding Modal -->
<div id="new-finding-modal" class="overlay" hidden>
  <div class="card-dark" style="width:720px; max-width:95%;">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h3 style="margin:0">New Archaeological Finding</h3>
      <button id="close-new-finding" class="btn btn-ghost btn-sm">Close</button>
    </div>
    <!-- NOTE: form updated to include submitterEmail for Formspree -->
    <form id="new-finding-form" class="form-compact">
      <div class="d-flex gap-2">
        <input name="repo" placeholder="Repository path (e.g. europe/greece/crete/knossos)" class="form-control form-control-sm" required />
        <select name="type" class="form-select form-select-sm" style="width:180px;">
          <option>Discovery</option>
          <option>Analysis</option>
          <option>Theory</option>
          <option>Preservation</option>
          <option>Maintenance</option>
        </select>
      </div>
      <div class="mt-2"><input name="title" placeholder="Title" class="form-control form-control-sm" required /></div>

      <!-- Added optional submitter email for Formspree reply-to -->
      <div class="mt-2">
        <input name="submitterEmail" placeholder="Your email (optional)" class="form-control form-control-sm" />
      </div>

      <div class="mt-2"><textarea name="desc" placeholder="Description" class="form-control form-control-sm" rows="5"></textarea></div>
      <div class="mt-2 d-flex justify-content-end gap-2">
        <button type="button" id="submit-finding" class="btn btn-primary">Submit</button>
      </div>
    </form>

    <!-- Direct Formspree form as backup (submits to Formspree and opens result in new tab) -->
    <hr style="margin:12px 0; border-color:#30363d;">
    <div style="margin-top:8px;">
      <div style="font-weight:700; margin-bottom:8px;">Also send a message (direct Formspree form)</div>
      <form action="https://formspree.io/f/xdakdvqo" method="POST" class="form-compact" target="_blank">
        <label>
          Your email:
          <input type="email" name="email" class="form-control form-control-sm" />
        </label>
        <label>
          Your message:
          <textarea name="message" class="form-control form-control-sm" rows="4"></textarea>
        </label>
        <input type="hidden" name="_subject" value="ArcheoHub ‚Äî New finding (direct form)" />
        <div style="margin-top:8px; text-align:right;">
          <button type="submit" class="btn btn-ghost">Send via Formspree</button>
        </div>
      </form>
    </div>

  </div>
</div>

<!-- Login / Signup Modal -->
<div id="auth-modal" class="overlay" hidden>
  <div class="card-dark" style="width:420px; max-width:95%;">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h3 style="margin:0" id="auth-title">Sign in</h3>
      <button id="auth-close" class="btn btn-ghost btn-sm">Close</button>
    </div>
    <div>
      <div class="mb-2 small muted" id="auth-note">Use a Gmail address for demo sign-in (local only).</div>
      <input id="auth-email" class="form-control form-control-sm mb-2" placeholder="you@gmail.com" />
      <input id="auth-name" class="form-control form-control-sm mb-2" placeholder="Display name (optional)" />
      <div class="d-flex justify-content-end gap-2">
        <button id="auth-submit" class="btn btn-primary">Sign in</button>
      </div>
    </div>
  </div>
</div>

<!-- Simple toast -->
<div id="toast" style="position:fixed; right:18px; bottom:18px; z-index:14000;"></div>

<!-- Footer -->
<footer class="footer mt-5">
  <div class="container-lg text-center">
    <p class="mb-0">¬© 2026 ArcheoHub ‚Äî Prototype. Contact: <a href="mailto:shyn.aityk@gmail.com">shyn.aityk@gmail.com</a></p>
  </div>
</footer>

<script>
/* ----------------------------------------------------------------------------
   Full SPA code with Formspree integration added and Kazakhstan findings + map geocoding.
   I preserved your original application logic and inserted:
   - KZ_FINDINGS dataset (100 items provided by you)
   - AUTHORITATIVE_SOURCES array
   - geocoding helpers using Nominatim (rate-limited + cached in localStorage)
   - merge of Kazakhstan findings into App.repos for listing and mapping
   ---------------------------------------------------------------------------- */

/* Helpers */
function uid(prefix='id'){ return prefix + '-' + Math.random().toString(36).slice(2,9); }
function now(){ return new Date().toISOString(); }
function saveLS(key,value){ try { localStorage.setItem(key, JSON.stringify(value)); } catch(e){ console.warn('saveLS error', e); } }
function loadLS(key, fallback){ try{ const v = localStorage.getItem(key); return v ? JSON.parse(v) : fallback; }catch(e){ return fallback; } }
function toast(msg, ms=2500){ const t=document.createElement('div'); t.className='Box p-2 mb-2'; t.style.background='#0b1220'; t.textContent=msg; document.getElementById('toast').appendChild(t); setTimeout(()=>{ t.remove(); }, ms); }

/* Attach event if element exists; accepts element or selector */
function safeOn(target, event, handler){
  if(!target) return;
  let el = null;
  if(typeof target === 'string') el = document.querySelector(target);
  else el = target;
  if(el && typeof el.addEventListener === 'function') el.addEventListener(event, handler);
}

/* Basic HTML escape */
function escapeHTML(s){
  if (s === null || s === undefined) return '';
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

/* ----------------------------------------------------------------------------
   Formspree helper: sends JSON to your form endpoint.
   ---------------------------------------------------------------------------- */
const FORMSPREE_ENDPOINT = 'https://formspree.io/f/xdakdvqo';

async function sendFindingToFormspree(payload){
  try {
    const res = await fetch(FORMSPREE_ENDPOINT, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Accept': 'application/json'
      },
      body: JSON.stringify({
        email: payload.email || '',
        repo: payload.repoPath,
        type: payload.type,
        title: payload.title,
        message: payload.desc,
        author: payload.author,
        time: payload.time,
        _subject: ArcheoHub ‚Äî New finding: ${payload.title},
        _replyto: payload.email || ''
      })
    });
    if(res.ok) return { ok:true };
    const text = await res.text().catch(()=>null);
    console.warn('Formspree response not ok', res.status, text);
    return { ok:false, status:res.status, text };
  } catch(err){
    console.error('sendFindingToFormspree error', err);
    return { ok:false, error:String(err) };
  }
}

/* ----------------------------------------------------------------------------
   Application State (unchanged)
   ---------------------------------------------------------------------------- */
const App = {
  theme: localStorage.getItem('theme') || 'dark',
  user: loadLS('archeo_user', null),    // { email, displayName, bio, website }
  repos: loadLS('archeo_repos', null),
  issues: loadLS('archeo_issues', null),
  prs: loadLS('archeo_prs', null),
  page: 'explore',
  currentRepoId: null,
  filter: { type: '', search: '', yearRange: [-3000, 2020] }
};

document.documentElement.setAttribute('data-color-mode', App.theme);

/* ----------------------------------------------------------------------------
   Data seeding (unchanged except owners default to "community")
   ---------------------------------------------------------------------------- */
if(!App.repos){
  App.repos = [];
  const BASE = [
    ["Giza Plateau","Egypt",29.9792,31.1342],
    ["Pompeii","Italy",40.7460,14.4989],
    ["Stonehenge","UK",51.1789,-1.8262],
    ["Machu Picchu","Peru",-13.1631,-72.5450],
    ["Angkor Wat","Cambodia",13.4125,103.8667],
    ["Teotihuacan","Mexico",19.6925,-98.8438],
    ["G√∂bekli Tepe","Turkey",37.2231,38.9226],
    ["Petra","Jordan",30.3285,35.4444],
    ["Tikal","Guatemala",17.2220,-89.6237],
    ["Derinkuyu","Turkey",38.3745,34.7364]
  ];

  const COMMIT_TYPES = ["Discovery","Analysis","Theory","Preservation","Maintenance"];
  const authors = ["Dr. A. Silva","Prof. M. Chen","L. Ortega","S. Ibrahim","Y. Petrov","N. Okeke","E. Rossi","H. Nakamura"];
  const commitMsgs = ["Trench logged","Portable XRF sample","Radiocarbon sent to lab","Soil profile documented","Consolidation treatment","Geophysical survey added","Artifact cataloged","Initial report"];

  let rid = 1;
  BASE.forEach((b) => {
    for(let i=0;i<20;i++){
      const lat = b[2] + (Math.random()-0.5)*0.4;
      const lon = b[3] + (Math.random()-0.5)*0.4;
      const commits = [];
      const commitCount = Math.floor(Math.random()*14)+4;
      for(let c=0;c<commitCount;c++){
        const year = Math.floor(-3000 + Math.pow(Math.random(),0.8)*(2020+3000));
        const L = Math.floor(Math.random()*5)+1;
        const layers = [];
        for(let li=0; li<L; li++){
          layers.push({ id: uid('layer'), name:Layer ${li+1}, thickness: Math.round(Math.random()*50+5), color: ['#c2a97f','#8fbf9f','#c27ba0','#7fa7d9'][Math.floor(Math.random()*4)], notes: "Sample notes" });
        }
        commits.push({ id: ${rid}-c${c}, author: authors[Math.floor(Math.random()*authors.length)], year, type: COMMIT_TYPES[Math.floor(Math.random()*COMMIT_TYPES.length)], message: commitMsgs[Math.floor(Math.random()*commitMsgs.length)], layers });
      }
      commits.sort((a,b)=>a.year-b.year);
      App.repos.push({
        id: String(rid),
        name: ${b[0]} Sector ${i+1},
        site: b[0],
        country: b[1],
        lat, lon,
        image: https://images.unsplash.com/photo-1526772662000-3f88f10405ff?q=80&w=1400&auto=format&fit=crop&s=${Math.floor(Math.random()*100000)},
        commits,
        branches: [],
        stars: Math.floor(Math.random()*5000),
        forks: Math.floor(Math.random()*600),
        owner: 'community'
      });
      rid++;
    }
  });

  const extras = [
    ["Lascaux","France",45.053,1.167],
    ["Pavlopetri","Greece",36.7,22.45]
  ];
  extras.forEach((b)=>{
    const commits=[];
    for(let c=0;c<8;c++){
      commits.push({ id: uid('ex'), author: "A. Researcher", year: Math.floor(-3000 + Math.random()*5000), type: "Discovery", message: "Sample commit", layers:[{ id: uid('l'), name:"Topsoil", thickness:10, color:'#c2a97f' }] });
    }
    App.repos.push({ id: String(rid++), name:b[0], site:b[0], country:b[1]||'Unknown', lat:b[2], lon:b[3], image:'https://images.unsplash.com/photo-1526772662000-3f88f10405ff?q=80&w=1400', commits, branches:[], stars:0, forks:0, owner:'community' });
  });

  /* ------------------- NEW: Kazakhstan findings dataset ------------------- */
  // The 100 archaeological findings/sites you provided are included below.
  // Each entry has a name and era/category. Coordinates are resolved at runtime
  // via OpenStreetMap Nominatim (cached to localStorage).
  const KZ_FINDINGS = [
    /* Bronze Age & Early Iron Age (1‚Äì25) */
    { name: "Semiyarka Bronze Age city", era: "Bronze Age" },
    { name: "Akbaur Cave paintings", era: "Bronze Age" },
    { name: "Ainabulak‚ÄìTemirsu burial", era: "Bronze Age" },
    { name: "Andronovo culture dwellings (Karaganda)", era: "Bronze Age" },
    { name: "Karazhartas Necropolis", era: "Bronze Age" },
    { name: "Tasmola culture barrows", era: "Bronze Age" },
    { name: "Boralday necropolis", era: "Bronze Age" },
    { name: "Shilikty Valley royal kurgans", era: "Bronze Age" },
    { name: "Eleke Sazy burial complexes", era: "Bronze Age" },
    { name: "Akkainar petroglyphs", era: "Bronze Age" },
    { name: "Zhartas petroglyphs", era: "Bronze Age" },
    { name: "Tamgaly petroglyphs", era: "Bronze Age" },
    { name: "Begazy-Dandybai mausoleums", era: "Bronze Age" },
    { name: "Kent Bronze Age settlement", era: "Bronze Age" },
    { name: "Atasu Bronze Age metallurgical site", era: "Bronze Age" },
    { name: "Myrzhyk Bronze Age burial ground", era: "Bronze Age" },
    { name: "Buguly I settlement", era: "Bronze Age" },
    { name: "Buguly II burial site", era: "Bronze Age" },
    { name: "Sherubai-Nura Bronze Age settlement", era: "Bronze Age" },
    { name: "Karaganda Bronze Age copper mines", era: "Bronze Age" },
    { name: "Ulytau ritual stone complexes", era: "Bronze Age" },
    { name: "Saryarka Bronze Age settlements", era: "Bronze Age" },
    { name: "Kokshetau Bronze Age burial mounds", era: "Bronze Age" },
    { name: "Zhezkazgan ancient mining complex", era: "Bronze Age" },
    { name: "Turgai Bronze Age sites", era: "Bronze Age" },

    /* Saka / Scythian / Sarmatian Period (26‚Äì55) */
    { name: "Issyk kurgan (Golden Man)", era: "Saka/Scythian" },
    { name: "Araltobe Golden Man", era: "Saka/Scythian" },
    { name: "Shilikty Golden Man", era: "Saka/Scythian" },
    { name: "Eleke Sazy Golden Man", era: "Saka/Scythian" },
    { name: "Karabau-2 Sarmatian burial", era: "Sarmatian" },
    { name: "Togyzbulak Scythian burial mounds", era: "Scythian" },
    { name: "Toraygyr-7 Saka knives", era: "Saka/Scythian" },
    { name: "Berel kurgans (horse burials)", era: "Saka/Scythian" },
    { name: "Katon-Karagay Saka graves", era: "Saka/Scythian" },
    { name: "Baigetobe kurgan", era: "Saka/Scythian" },
    { name: "Mayemer Saka burial complex", era: "Saka/Scythian" },
    { name: "Saka ritual altars of Altai", era: "Saka/Scythian" },
    { name: "Sarmatian necropolis (Atyrau)", era: "Sarmatian" },
    { name: "Lebedevka Sarmatian site", era: "Sarmatian" },
    { name: "Prokhorovka culture graves", era: "Early nomadic" },
    { name: "Early nomad bronze cauldrons", era: "Early Iron Age" },
    { name: "Saka animal-style gold plaques", era: "Saka/Scythian" },
    { name: "Scythian arrowheads of East Kazakhstan", era: "Scythian" },
    { name: "Saka ceremonial mirrors", era: "Saka/Scythian" },
    { name: "Gold belt fittings from Zhetysu", era: "Saka/Scythian" },
    { name: "Sarmatian swords (Akinakai)", era: "Sarmatian" },
    { name: "Horse harness decorations (gold)", era: "Saka/Scythian" },
    { name: "Saka burial masks", era: "Saka/Scythian" },
    { name: "Sarmatian pottery complexes", era: "Sarmatian" },
    { name: "Scythian bronze cauldrons", era: "Scythian" },

    /* Ancient & Medieval Cities (56‚Äì80) */
    { name: "Otrar (Farab)", era: "Medieval" },
    { name: "Turkestan (Yassi)", era: "Medieval" },
    { name: "Sauran", era: "Medieval" },
    { name: "Taraz (Talas)", era: "Medieval" },
    { name: "Jankent", era: "Medieval" },
    { name: "Balasagun", era: "Medieval" },
    { name: "Kulan", era: "Medieval" },
    { name: "Talgar (Talkhir)", era: "Medieval" },
    { name: "Kayalyk (Antonovka)", era: "Medieval" },
    { name: "Zhankala medieval city", era: "Medieval" },
    { name: "Sumbe settlement", era: "Medieval" },
    { name: "Aktobe medieval site", era: "Medieval" },
    { name: "Akyrtas palace complex", era: "Medieval" },
    { name: "Koilyk city ruins", era: "Medieval" },
    { name: "Karatau Silk Road fortresses", era: "Medieval" },
    { name: "Zhetysu caravanserai ruins", era: "Medieval" },
    { name: "Steppe geoglyph complexes (Torgai)", era: "Medieval/Geoglyph" },
    { name: "Burned medieval city (Zhetysu)", era: "Medieval" },
    { name: "Kimak Khaganate capital (Pavlodar region)", era: "Medieval" },
    { name: "Kipchak settlements of Saryarka", era: "Medieval" },
    { name: "Golden Horde city ruins", era: "Medieval" },
    { name: "Medieval bathhouse ruins (Taraz)", era: "Medieval" },
    { name: "Mosque foundations of Otrar", era: "Medieval" },
    { name: "Necropolis of Turkestan", era: "Medieval" },
    { name: "Defensive walls of Sauran", era: "Medieval" },

    /* Rock Art & Prehistoric Sites (81‚Äì100) */
    { name: "Arpa-Uzen petroglyphs", era: "Rock Art" },
    { name: "Eshkiolmes petroglyphs", era: "Rock Art" },
    { name: "Karatau rock art complexes", era: "Rock Art" },
    { name: "Bayanzhurek petroglyphs", era: "Rock Art" },
    { name: "Kulzhabasy petroglyphs", era: "Rock Art" },
    { name: "Sauyskandyk petroglyphs", era: "Rock Art" },
    { name: "Shakpakata cave sites", era: "Rock Art" },
    { name: "Mangystau necropolis rock carvings", era: "Rock Art" },
    { name: "Paleolithic site of Shulbinka", era: "Paleolithic" },
    { name: "Mesolithic sites of North Kazakhstan", era: "Mesolithic" },
    { name: "Neolithic settlements near Irtysh", era: "Neolithic" },
    { name: "Eneolithic Botai culture settlement", era: "Eneolithic" },
    { name: "Botai horse domestication evidence", era: "Eneolithic" },
    { name: "Krasnyi Yar site", era: "Prehistoric" },
    { name: "Urpek settlement", era: "Prehistoric" },
    { name: "Dongtalede prehistoric site", era: "Prehistoric" },
    { name: "Ilibalyk archaeological site", era: "Prehistoric" },
    { name: "Bogen Reservoir submerged sites", era: "Submerged/Recent" },
    { name: "Stone tool workshops of Altai", era: "Prehistoric" },
    { name: "Early ritual stone alignments of Ulytau", era: "Prehistoric" }
  ];

  // Authoritative references (as requested)
  const AUTHORITATIVE_SOURCES = [
    { name: "Institute of Archaeology of Kazakhstan", url: "https://iie.kz" },
    { name: "E-History (Kazakh digital history)", url: "https://e-history.kz" },
    { name: "UNESCO World Heritage Centre", url: "https://whc.unesco.org" },
    { name: "Archaeology of Kazakhstan - Wikipedia", url: "https://en.wikipedia.org/wiki/Archaeology_of_Kazakhstan" }
  ];

  // Merge KZ findings into App.repos so they appear in lists and the map.
  // Each finding becomes a repo-like object with country 'Kazakhstan'. Coordinates are resolved later.
  KZ_FINDINGS.forEach((f, idx) => {
    const id = String(rid++);
    App.repos.push({
      id,
      name: f.name,
      site: f.name,
      country: 'Kazakhstan',
      lat: null,   // will be geocoded
      lon: null,
      image: 'https://images.unsplash.com/photo-1500048993953-df4e0b5a1d5d?q=80&w=1400&auto=format&fit=crop&s=placeholder',
      commits: [{ id: uid('c'), author: 'Dataset', year: -1000, type: 'Discovery', message: f.era || 'Discovery', layers: [] }],
      branches: [],
      stars: 0,
      forks: 0,
      owner: 'kazakh-dataset',
      meta: { era: f.era || '', sources: AUTHORITATIVE_SOURCES.map(s=>s.url) }
    });
  });

  saveLS('archeo_repos', App.repos);
}

/* Issues & PRs basic seed */
if(!App.issues){
  App.issues = [
    { id: uid('iss'), title: "Artifact numbering mismatch", repoId: App.repos[0].id, status: "todo", author: "Dr. A. Silva", created: now(), comments: [] },
    { id: uid('iss'), title: "Layer depth discrepancy", repoId: App.repos[1].id, status: "inprogress", author: "E. Rossi", created: now(), comments: [] }
  ];
  saveLS('archeo_issues', App.issues);
}
if(!App.prs){
  App.prs = [
    { id: uid('pr'), title: "Add geophysical survey results", repoId: App.repos[2].id, author: "L. Ortega", created: now(), status: "open", description: "Adding XRF layer results." }
  ];
  saveLS('archeo_prs', App.prs);
}

/* ----------------------------------------------------------------------------
   Geocoding helpers: Nominatim search, caching, rate-limited batch geocode
   - Results saved to localStorage under 'geo_cache'
   - On success the App.repos entry lat/lon is updated and map markers added
   ---------------------------------------------------------------------------- */
const GEO_CACHE_KEY = 'geo_cache_v1';
function loadGeoCache(){ return loadLS(GEO_CACHE_KEY, {}); }
function saveGeoCache(cache){ saveLS(GEO_CACHE_KEY, cache); }

async function nominatimSearch(query){
  // Nominatim usage policy: add a proper user-agent and spacing between queries.
  const url = https://nominatim.openstreetmap.org/search?format=jsonv2&limit=1&q=${encodeURIComponent(query)};
  try {
    const res = await fetch(url, {
      headers: { 'Accept': 'application/json', 'Referer': location.origin },
    });
    if(!res.ok) return null;
    const data = await res.json();
    if(Array.isArray(data) && data.length>0){
      return { lat: Number(data[0].lat), lon: Number(data[0].lon), display_name: data[0].display_name };
    }
    return null;
  } catch(err){
    console.warn('nominatimSearch error', err);
    return null;
  }
}

function sleep(ms){ return new Promise(resolve => setTimeout(resolve, ms)); }

async function geocodeKazakhstanFindings(rateMs = 1200){
  // Find App.repos entries that are Kazakhstan and need geocoding
  const cache = loadGeoCache();
  const toGeocode = App.repos.filter(r => r.country === 'Kazakhstan' && (!r.lat || !r.lon));
  if(toGeocode.length === 0) return;
  console.log(Geocoding ${toGeocode.length} Kazakhstan findings (rate ${rateMs}ms));
  for(const repo of toGeocode){
    const key = kz:${repo.name};
    if(cache[key]){
      repo.lat = cache[key].lat;
      repo.lon = cache[key].lon;
      // add marker if map exists
      if(window.__archeo_map && repo.lat && repo.lon && !window.__archeo_map._locked){
        try {
          const marker = L.circleMarker([repo.lat, repo.lon], { radius:6, color:'#071625', fillColor:'#f6c85f', fillOpacity:0.95 }).addTo(window.__archeo_map);
          marker.bindPopup(<div style="width:240px;"><strong>${escapeHTML(repo.name)}</strong><div class="muted small">${escapeHTML(repo.meta?.era||'')}</div><div class="small" style="margin-top:6px;">Sources: ${escapeHTML(AUTHORITATIVE_SOURCES[0].name)}</div></div>);
          (window.__archeo_mapMarkers ||= []).push(marker);
        } catch(e){ console.warn('add marker from cache failed', e); }
      }
      continue;
    }
    // try to geocode name + Kazakhstan to improve accuracy
    const query = ${repo.name}, Kazakhstan;
    const res = await nominatimSearch(query);
    if(res){
      cache[key] = { lat: res.lat, lon: res.lon, name: res.display_name, time: now() };
      repo.lat = res.lat;
      repo.lon = res.lon;
      saveLS('archeo_repos', App.repos);
      // add marker to existing map
      if(window.__archeo_map){
        try {
          const marker = L.circleMarker([repo.lat, repo.lon], { radius:6, color:'#071625', fillColor:'#f6c85f', fillOpacity:0.95 }).addTo(window.__archeo_map);
          marker.bindPopup(<div style="width:240px;"><strong>${escapeHTML(repo.name)}</strong><div class="muted small">${escapeHTML(repo.meta?.era||'')}</div><div class="small" style="margin-top:6px;">Sources: ${escapeHTML(AUTHORITATIVE_SOURCES[0].name)}</div></div>);
          (window.__archeo_mapMarkers ||= []).push(marker);
        } catch(e){ console.warn('add marker failed', e); }
      }
    } else {
      // fallback: try without "Kazakhstan" (rare)
      const res2 = await nominatimSearch(repo.name);
      if(res2){
        cache[key] = { lat: res2.lat, lon: res2.lon, name: res2.display_name, time: now() };
        repo.lat = res2.lat;
        repo.lon = res2.lon;
        saveLS('archeo_repos', App.repos);
        if(window.__archeo_map){
          try {
            const marker = L.circleMarker([repo.lat, repo.lon], { radius:6, color:'#071625', fillColor:'#f6c85f', fillOpacity:0.95 }).addTo(window.__archeo_map);
            marker.bindPopup(<div style="width:240px;"><strong>${escapeHTML(repo.name)}</strong><div class="muted small">${escapeHTML(repo.meta?.era||'')}</div><div class="small" style="margin-top:6px;">Sources: ${escapeHTML(AUTHORITATIVE_SOURCES[0].name)}</div></div>);
            (window.__archeo_mapMarkers ||= []).push(marker);
          } catch(e){ console.warn('add marker failed', e); }
        }
      } else {
        // no coords found; leave null
      }
    }
    // store cache after each iteration to be safe
    saveGeoCache(cache);
    // respect rate limit / polite delay
    await sleep(rateMs);
  }
  // final save
  saveGeoCache(cache);
}

/* ----------------------------------------------------------------------------
   Routing & Navigation
   ---------------------------------------------------------------------------- */
function navigate(page, opts={}){
  App.page = page;
  if(opts.repoId) App.currentRepoId = opts.repoId;
  try { history.pushState({page, opts}, '', #${page}${opts.repoId?'-'+opts.repoId:''}); } catch(e){}
  render();
}
window.addEventListener('popstate', ()=> {
  const h = window.location.hash.slice(1);
  if(!h) { App.page='explore'; App.currentRepoId=null; } else {
    const parts = h.split('-');
    App.page = parts[0] || 'explore';
    App.currentRepoId = parts[1] || null;
  }
  render();
});

/* ----------------------------------------------------------------------------
   Auth & Profile helpers
   ---------------------------------------------------------------------------- */
function setUser(user){
  App.user = user;
  saveLS('archeo_user', user);
  updateHeaderAuth();
}
function signOut(){
  App.user = null;
  localStorage.removeItem('archeo_user');
  updateHeaderAuth();
  toast('Signed out');
}
function updateHeaderAuth(){
  const el = document.getElementById('avatar-img');
  const emailEl = document.getElementById('user-email');
  if(App.user){
    const initials = (App.user.displayName||App.user.email).split(' ').map(s=>s[0]).slice(0,2).join('').toUpperCase();
    el.src = https://avatars.dicebear.com/api/initials/${encodeURIComponent(initials)}.svg;
    emailEl.textContent = App.user.email;
  } else {
    el.src = 'https://avatars.githubusercontent.com/u/0?v=4';
    emailEl.textContent = 'guest';
  }
}

/* Centralized delete helpers */
function deleteIssue(issueId){
  const idx = App.issues.findIndex(i => i.id === issueId);
  if(idx === -1) return false;
  if(!confirm('Delete this issue? This cannot be undone.')) return false;
  App.issues.splice(idx, 1);
  saveLS('archeo_issues', App.issues);
  toast('Issue deleted');
  render();
  return true;
}
function deletePR(prId){
  const idx = App.prs.findIndex(p => p.id === prId);
  if(idx === -1) return false;
  if(!confirm('Delete this pull request? This cannot be undone.')) return false;
  App.prs.splice(idx, 1);
  saveLS('archeo_prs', App.prs);
  toast('Pull request deleted');
  render();
  return true;
}

/* Auth modal wiring */
safeOn('#auth-submit', 'click', ()=>{
  const email = (document.getElementById('auth-email') || {}).value || '';
  const name = (document.getElementById('auth-name') || {}).value || '';
  if(!email || !email.endsWith('@gmail.com')) { alert('Please provide a valid @gmail.com address (demo).'); return; }
  const user = Object.assign({ bio:'', website:'' }, { email, displayName: name || email.split('@')[0] });
  setUser(user);
  const authModal = document.getElementById('auth-modal');
  if(authModal) authModal.hidden = true;
  toast('Signed in as ' + user.email);
});
safeOn('#auth-close', 'click', ()=> { const m = document.getElementById('auth-modal'); if(m) m.hidden = true; });
safeOn('#logout-btn', 'click', ()=> signOut());

/* Avatar click: if signed-in navigate to profile; if not, show auth modal */
document.querySelectorAll('details > summary').forEach(s=>{
  s.addEventListener('click', (e)=>{
    const details = e.currentTarget.parentElement;
    if(!App.user && details.classList.contains('details-overlay')){
      e.preventDefault();
      const m = document.getElementById('auth-modal'); if(m) m.hidden = false;
    } else {
      e.preventDefault();
      if(details) details.removeAttribute('open');
      navigate('profile');
    }
  });
});

/* Theme toggle and new finding wiring */
safeOn('#theme-toggle', 'click', ()=>{
  App.theme = App.theme === 'dark' ? 'light' : 'dark';
  document.documentElement.setAttribute('data-color-mode', App.theme);
  localStorage.setItem('theme', App.theme);
});
safeOn('#new-finding-btn','click', ()=> {
  const m = document.getElementById('new-finding-modal'); if(m) m.hidden = false;
});
safeOn('#close-new-finding','click', ()=> { const m = document.getElementById('new-finding-modal'); if(m) m.hidden = true; });

/* New finding: record owner when creating a repo AND send to Formspree */
safeOn('#submit-finding','click', async ()=>{
  const form = document.getElementById('new-finding-form');
  if(!form) return;
  const repoPath = (form.repo || {}).value ? form.repo.value.trim() : '';
  const title = form.title.value.trim();
  const type = form.type.value;
  const desc = form.desc.value.trim();
  const submitterEmail = form.submitterEmail ? form.submitterEmail.value.trim() : (App.user ? App.user.email : '');

  if(!repoPath || !title){ alert('Please provide a repository path and title'); return; }
  let repo = App.repos.find(r=> r.name.toLowerCase() === repoPath.toLowerCase());
  if(!repo){
    repo = {
      id: String(App.repos.length+1),
      name: repoPath,
      site: repoPath.split('/')[0] || 'unknown',
      country: 'Unknown',
      lat: 0, lon: 0,
      image: 'https://images.unsplash.com/photo-1526772662000-3f88f10405ff?q=80&w=1400',
      commits: [],
      branches: [],
      stars: 0,
      forks: 0,
      owner: App.user ? App.user.displayName : 'guest'
    };
    App.repos.unshift(repo);
  }
  const commit = { id: uid('c'), author: App.user ? App.user.displayName : 'guest', year: new Date().getFullYear(), type, message: title, layers:[{id:uid('L'), name:'new layer', thickness:10, color:'#c2a97f'}] };
  repo.commits.push(commit);
  saveLS('archeo_repos', App.repos);

  // Build email payload
  const payload = {
    repoPath,
    title,
    type,
    desc,
    author: App.user ? App.user.displayName : 'guest',
    email: submitterEmail,
    time: new Date().toISOString()
  };

  // UI: disable submit button while sending
  const submitBtn = document.getElementById('submit-finding');
  if(submitBtn) { submitBtn.disabled = true; submitBtn.textContent = 'Sending‚Ä¶'; }

  // send to Formspree
  const result = await sendFindingToFormspree(payload);

  // restore button
  if(submitBtn) { submitBtn.disabled = false; submitBtn.textContent = 'Submit'; }

  if(result.ok) {
    toast('Finding submitted and emailed');
  } else {
    toast('Finding submitted (email failed - check console)');
  }

  const m = document.getElementById('new-finding-modal'); if(m) m.hidden = true;
  render();
});

/* ----------------------------------------------------------------------------
   Renderers (full implementations preserved)
   - render, renderExplore, renderMap, renderRepo, loadRepoTab, renderIssuesBoard,
     renderPRList, mergePR, openDiffChooser, showDiffResults, open3DViewer,
     renderProfile, exportContributionsCSV
   The original full implementations are present below (kept intact).
   ---------------------------------------------------------------------------- */

function repoCardHTML(repo){
  const latest = repo.commits[repo.commits.length-1];
  return 
    <div class="Box-row">
      <div style="flex:1">
        <div class="repo-title"><a href="#" data-route="repo" data-repo="${repo.id}">${escapeHTML(repo.name)}</a></div>
        <div class="small muted">${escapeHTML(repo.site)} ‚Ä¢ ${escapeHTML(repo.country)}</div>
        <div class="small muted" style="margin-top:6px;">${escapeHTML(latest ? (latest.type + ' ‚Ä¢ ' + latest.year + ' ‚Ä¢ ' + latest.message) : 'No commits')}</div>
      </div>
      <div style="text-align:right;">
        <div class="small muted">‚òÖ ${repo.stars}</div>
        <div style="margin-top:8px;">
          <button class="btn btn-sm btn-ghost" data-action="star" data-id="${repo.id}">Star</button>
          <button class="btn btn-sm btn-primary" data-action="open" data-id="${repo.id}">Open</button>
        </div>
      </div>
    </div>
  ;
}

function render(){
  updateHeaderAuth();
  const root = document.getElementById('app-root');
  if(!root) return;
  root.innerHTML = '';

  const globalSearch = document.getElementById('global-search');
  if(globalSearch){
    globalSearch.onkeypress = (e)=>{
      if(e.key === 'Enter'){
        App.filter.search = e.target.value.trim();
        navigate('explore');
      }
    };
  }

  if(App.page === 'explore') return renderExplore(root);
  if(App.page === 'map') return renderMap(root);
  if(App.page === 'repo') return renderRepo(root, App.currentRepoId);
  if(App.page === 'profile') return renderProfile(root);
  if(App.page === 'issues') return renderIssuesBoard(root);
  if(App.page === 'prs') return renderPRList(root);

  renderExplore(root);
}

/* Explore */
function renderExplore(root){
  root.innerHTML = 
    <div class="two-col">
      <div>
        <div class="Box mb-4">
          <div class="Box-title">Explore repositories</div>
          <div id="repo-list" class="Box-body p-0"></div>
        </div>

        <div class="Box mt-4">
          <div class="Box-title">Timeline</div>
                  <div class="Box-body p-3">
            <div id="timeline"></div>
        </div>
        </div>
      </div>

      <div class="panel-right">
        <div class="Box">
          <div class="Box-title">Quick stats</div>
          <div class="Box-row small">Repositories: <strong>${App.repos.length}</strong></div>
          <div class="Box-row small">Issues: <strong>${App.issues.length}</strong></div>
          <div class="Box-row small">Pull Requests: <strong>${App.prs.length}</strong></div>
        </div>
      </div>
    </div>
  `;

  const list = root.querySelector('#repo-list');
  const q = (App.filter.search || '').toLowerCase();

  App.repos
    .filter(r => !q || r.name.toLowerCase().includes(q) || r.site.toLowerCase().includes(q))
    .forEach(r => list.insertAdjacentHTML('beforeend', repoCardHTML(r)));

  list.addEventListener('click', (e)=>{
    const open = e.target.closest('[data-action="open"]');
    const star = e.target.closest('[data-action="star"]');
    const link = e.target.closest('a[data-repo]');
    if(open) navigate('repo', { repoId: open.dataset.id });
    if(link) navigate('repo', { repoId: link.dataset.repo });
    if(star){
      const repo = App.repos.find(r=>r.id===star.dataset.id);
      if(repo){ repo.stars++; saveLS('archeo_repos', App.repos); render(); }
    }
  });

  const timeline = document.getElementById('timeline');
  noUiSlider.create(timeline, {
    start: App.filter.yearRange,
    connect: true,
    step: 10,
    range: { min: -3000, max: 2020 }
  });
  timeline.noUiSlider.on('change', (v)=>{
    App.filter.yearRange = v.map(n=>Math.round(n));
  });
}

/* Map */
function renderMap(root){
  root.innerHTML = `<div id="map"></div>`;
  const map = L.map('map').setView([48, 67], 4);
  window.__archeo_map = map;
  window.__archeo_mapMarkers = [];
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
    maxZoom:18, attribution:'¬© OpenStreetMap'
  }).addTo(map);

  App.repos.forEach(r=>{
    if(r.lat && r.lon){
      const m = L.circleMarker([r.lat,r.lon],{radius:6}).addTo(map);
      m.bindPopup(`<strong>${escapeHTML(r.name)}</strong><br>${escapeHTML(r.country)}`);
      window.__archeo_mapMarkers.push(m);
    }
  });

  geocodeKazakhstanFindings();
}

/* Repo */
function renderRepo(root, id){
  const repo = App.repos.find(r=>r.id===id);
  if(!repo){ root.innerHTML='<p>Repo not found</p>'; return; }

  root.innerHTML = `
    <div class="Box mb-4">
      <div class="Box-title">${escapeHTML(repo.name)}</div>
      <div class="Box-row small muted">${escapeHTML(repo.site)} ‚Ä¢ ${escapeHTML(repo.country)}</div>
    </div>
    <div class="Box">
      <div class="Box-title">Commits</div>
      ${repo.commits.map(c=>`
        <div class="Box-row small">
          <div>${escapeHTML(c.message)}</div>
          <div class="muted">${escapeHTML(c.author)} ‚Ä¢ ${c.year}</div>
        </div>
      `).join('')}
    </div>
  `;
}

/* Issues */
function renderIssuesBoard(root){
  root.innerHTML = `
    <div class="Box">
      <div class="Box-title">Issues</div>
      ${App.issues.map(i=>`
        <div class="Box-row small">
          <div>${escapeHTML(i.title)}</div>
          <div>
            <button class="btn btn-sm btn-ghost" data-del="${i.id}">Delete</button>
          </div>
        </div>
      `).join('')}
    </div>
  `;
  root.onclick = e=>{
    const b = e.target.closest('[data-del]');
    if(b) deleteIssue(b.dataset.del);
  };
}

/* PRs */
function renderPRList(root){
  root.innerHTML = `
    <div class="Box">
      <div class="Box-title">Pull Requests</div>
      ${App.prs.map(p=>`
        <div class="Box-row small">
          <div>${escapeHTML(p.title)}</div>
          <div>
            <button class="btn btn-sm btn-ghost" data-del="${p.id}">Delete</button>
          </div>
        </div>
      `).join('')}
    </div>
  `;
  root.onclick = e=>{
    const b = e.target.closest('[data-del]');
    if(b) deletePR(b.dataset.del);
  };
}

/* Profile */
function renderProfile(root){
  if(!App.user){
    root.innerHTML = `<p class="muted">Sign in to view profile.</p>`;
    return;
  }
  root.innerHTML = `
    <div class="Box">
      <div class="Box-title">Profile</div>
      <div class="Box-row">Email: ${escapeHTML(App.user.email)}</div>
      <div class="Box-row">Name: ${escapeHTML(App.user.displayName||'')}</div>
    </div>
  `;
}

/* initial route */
(function(){
  const h = location.hash.slice(1);
  if(h){
    const p = h.split('-');
    App.page = p[0];
    App.currentRepoId = p[1]||null;
  }
  render();
})();
