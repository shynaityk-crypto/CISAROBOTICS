<!doctype html>
<html lang="en" data-color-mode="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ArcheoHub ‚Äî Ultimate Git for Archaeology | 100 Sites of Kazakhstan</title>
  <!-- GitHub Primer CSS -->
  <link rel="stylesheet" href="https://unpkg.com/@primer/css@^21.0.0/dist/primer.css">
  <!-- Leaflet Map -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
  <!-- noUiSlider Timeline -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.0/nouislider.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.0/nouislider.min.js"></script>
  <!-- Three.js + OrbitControls for 3D -->
  <script src="https://unpkg.com/three@0.152.2/build/three.min.js"></script>
  <script src="https://unpkg.com/three@0.152.2/examples/js/controls/OrbitControls.js"></script>
  <!-- Chart.js for contribution graphs -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    /* ========================================================================
       Custom Styling ‚Äî Modern GitHub-inspired with archaeology theme
       ======================================================================== */
    :root {
      --accent: #238636;
      --muted: #8b949e;
      --bronze: #a0522d;
      --saka: #b8860b;
      --medieval: #2e8b57;
      --prehistoric: #800080;
      --bg: #0d1117;
      --card: #161b22;
      --border: #30363d;
    }
    body {
      background: var(--bg);
      color: #c9d1d9;
      font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Helvetica,Arial,sans-serif;
      margin: 0;
      line-height: 1.6;
    }
    header.Header {
      background: var(--card);
      border-bottom: 1px solid var(--border);
      padding: 16px 0;
    }
    .brand {
      font-weight: 800;
      font-size: 1.6rem;
      color: #f0f6fc;
    }
    .Header-link {
      color: #c9d1d9;
      font-weight: 600;
      padding: 8px 16px;
      border-radius: 6px;
    }
    .Header-link:hover {
      background: rgba(88,166,255,0.1);
      color: #fff;
    }
    .form-control.input-contrast,
    .form-select {
      background: var(--bg);
      color: #c9d1d9;
      border: 1px solid var(--border);
      border-radius: 8px;
    }
    .Box {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
    }
    .Box-title {
      background: rgba(22,27,34,0.8);
      padding: 20px;
      font-size: 1.3rem;
      font-weight: 600;
      border-bottom: 1px solid var(--border);
    }
    .Box-body {
      padding: 20px;
    }
    .Box-row {
      border-top: 1px solid var(--border);
      padding: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: background 0.2s;
    }
    .Box-row:hover {
      background: rgba(88,166,255,0.05);
    }
    .Box-row:first-child { border-top: 0; }
    .Label {
      font-size: 13px;
      padding: 6px 12px;
      border-radius: 2em;
      font-weight: 600;
    }
    .btn-primary {
      background: var(--accent);
      border-color: var(--accent);
      font-weight: 600;
      border-radius: 8px;
    }
    footer.footer {
      color: var(--muted);
      border-top: 1px solid var(--border);
      padding: 64px 0;
      margin-top: 100px;
    }
    .container-lg {
      max-width: 1400px;
      margin: 0 auto;
      padding: 40px;
    }
    .two-col {
      display: grid;
      grid-template-columns: 1fr 420px;
      gap: 40px;
    }
    @media (max-width: 1200px) {
      .two-col { grid-template-columns: 1fr; }
    }
    #map {
      height: 720px;
      border-radius: 12px;
      border: 1px solid var(--border);
    }
    .repo-title {
      font-weight: 700;
      color: #58a6ff;
      font-size: 1.3rem;
    }
    .muted { color: var(--muted); }
    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(2,6,23,0.95);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 12000;
      backdrop-filter: blur(12px);
    }
    .card-dark {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 40px;
      max-width: 95%;
      box-shadow: 0 16px 64px rgba(0,0,0,0.6);
    }
    .small { font-size: 14px; }
    .btn-ghost {
      background: transparent;
      border: 1px solid rgba(255,255,255,0.15);
      color: #c9d1d9;
      border-radius: 8px;
    }
    .tabs {
      display: flex;
      border-bottom: 1px solid var(--border);
    }
    .tabs .tab {
      cursor: pointer;
      padding: 16px 24px;
      font-weight: 600;
    }
    .tabs .tab.selected {
      color: var(--accent);
      border-bottom: 3px solid var(--accent);
    }
    .contrib-calendar {
      display: grid;
      grid-template-columns: repeat(52, 14px);
      gap: 4px;
      margin-top: 24px;
    }
    .contrib-day {
      width: 14px;
      height: 14px;
      background: #161b22;
      border-radius: 3px;
    }
    .contrib-day[data-level="1"] { background: #0d4429; }
    .contrib-day[data-level="2"] { background: #196c2e; }
    .contrib-day[data-level="3"] { background: #2ea043; }
    .contrib-day[data-level="4"] { background: #39d353; }
    .legend {
      position: absolute;
      bottom: 32px;
      left: 32px;
      background: rgba(13,17,23,0.9);
      padding: 20px;
      border-radius: 12px;
      border: 1px solid var(--border);
      z-index: 1000;
      backdrop-filter: blur(8px);
    }
    .legend-item {
      display: flex;
      align-items: center;
      gap: 16px;
      margin: 12px 0;
      font-size: 15px;
      font-weight: 500;
    }
    .legend-color {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      border: 3px solid var(--border);
    }
    .toast {
      animation: slideIn 0.4s ease-out;
    }
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
  </style>
</head>
<body>
<!-- ========================================================================
     Header ‚Äî Navigation, Search, Theme Toggle, New Finding, Auth
     ======================================================================== -->
<header class="Header d-flex flex-justify-between flex-items-center p-4">
  <div class="d-flex flex-items-center">
    <a class="brand mr-6">üè∫ ArcheoHub</a>
    <nav class="d-none d-md-block">
      <a class="Header-link" href="#" data-route="explore">Explore</a>
      <a class="Header-link ml-5" href="#" data-route="map">Map</a>
      <a class="Header-link ml-5" href="#" data-route="issues">Issues</a>
      <a class="Header-link ml-5" href="#" data-route="prs">Pull Requests</a>
      <a class="Header-link ml-5" href="#" data-route="profile">Profile</a>
    </nav>
  </div>
  <div style="flex:1; max-width:800px; margin:0 40px;">
    <input id="global-search" type="search" class="form-control input-contrast w-100" placeholder="Search 100 Kazakhstan sites, kurgans, petroglyphs, artifacts‚Ä¶" />
  </div>
  <div class="d-flex flex-items-center gap-5">
    <button id="theme-toggle" class="btn btn-ghost btn-lg" title="Toggle dark/light theme">üåó</button>
    <button id="new-finding-btn" class="btn btn-primary btn-lg">+ New Finding</button>
    <details class="details-reset details-overlay">
      <summary class="Header-link">
        <img id="avatar-img" class="avatar avatar-user" src="https://avatars.githubusercontent.com/u/0?v=4" width="48" height="48" alt="@guest">
      </summary>
      <div class="dropdown-menu dropdown-menu-sw mt-4" style="width:320px;">
        <div class="dropdown-header p-4">Signed in as <strong id="user-email">guest</strong></div>
        <a class="dropdown-item" href="#" data-route="profile">Your profile</a>
        <a class="dropdown-item" href="#" id="logout-btn">Sign out</a>
      </div>
    </details>
  </div>
</header>

<!-- ========================================================================
     Main Container ‚Äî Hero text and app root
     ======================================================================== -->
<div class="container-lg">
  <div class="mb-8">
    <h1 class="f00-light mb-4">ArcheoHub ‚Äî Git for Archaeology</h1>
    <p class="f1 muted mb-3">The ultimate prototype featuring 100 archaeological treasures of Kazakhstan</p>
    <p class="f3 muted">Golden warriors ‚Ä¢ Ancient petroglyphs ‚Ä¢ Silk Road cities ‚Ä¢ Bronze Age mines ‚Ä¢ Saka kurgans</p>
    <p class="f4 muted mt-6">Professional-grade features: 3D stratigraphy, diffs, issues, PRs, timeline, map clustering, contribution graphs, exports, Formspree submissions</p>
  </div>
  <div id="app-root"></div>
</div>

<!-- ========================================================================
     New Finding Modal ‚Äî Enhanced form with better UX
     ======================================================================== -->
<div id="new-finding-modal" class="overlay" hidden>
  <div class="card-dark" style="width:960px;">
    <div class="d-flex flex-justify-between flex-items-center mb-6">
      <h2 class="f00-light">Submit New Archaeological Finding</h2>
      <button id="close-new-finding" class="btn btn-ghost btn-lg">‚úï</button>
    </div>
    <form id="new-finding-form">
      <div class="d-flex gap-5 mb-5">
        <div style="flex:2;">
          <label class="f4 mb-2">Repository path</label>
          <input name="repo" placeholder="e.g. kazakhstan/altai/berel-kurgans" class="form-control form-control-lg" required />
        </div>
        <div style="flex:1;">
          <label class="f4 mb-2">Type</label>
          <select name="type" class="form-select form-select-lg">
            <option>Discovery</option>
            <option>Analysis</option>
            <option>Theory</option>
            <option>Preservation</option>
            <option>Maintenance</option>
          </select>
        </div>
      </div>
      <label class="f4 mb-2">Title</label>
      <input name="title" placeholder="e.g. New horse burial discovered in frozen kurgan" class="form-control form-control-lg mb-5" required />
      <label class="f4 mb-2">Your email (optional)</label>
      <input name="submitterEmail" placeholder="you@gmail.com" class="form-control mb-5" />
      <label class="f4 mb-2">Description</label>
      <textarea name="desc" placeholder="Full description, context, coordinates, references..." class="form-control" rows="12"></textarea>
      <div class="d-flex flex-justify-end gap-5 mt-6">
        <button type="button" id="submit-finding" class="btn btn-primary btn-lg">Submit & Send Email</button>
      </div>
    </form>
    <hr style="border-color:var(--border); margin:64px 0;">
    <div>
      <h3>Direct Formspree Backup</h3>
      <form action="https://formspree.io/f/xdakdvqo" method="POST" target="_blank">
        <input type="email" name="email" placeholder="Your email" class="form-control mb-4" />
        <textarea name="message" placeholder="Your full message" class="form-control" rows="8"></textarea>
        <input type="hidden" name="_subject" value="ArcheoHub direct finding" />
        <div class="mt-5 text-right">
          <button type="submit" class="btn btn-ghost btn-lg">Send via Formspree</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- ========================================================================
     Auth Modal ‚Äî Simple demo login
     ======================================================================== -->
<div id="auth-modal" class="overlay" hidden>
  <div class="card-dark" style="width:520px;">
    <div class="d-flex flex-justify-between mb-6">
      <h3>Demo Sign In</h3>
      <button id="auth-close" class="btn btn-ghost btn-lg">‚úï</button>
    </div>
    <p class="mb-5">Use any @gmail.com address ‚Äî data is stored locally only.</p>
    <input id="auth-email" class="form-control form-control-lg mb-4" placeholder="you@gmail.com" />
    <input id="auth-name" class="form-control form-control-lg mb-6" placeholder="Display name (optional)" />
    <div class="text-right">
      <button id="auth-submit" class="btn btn-primary btn-lg">Sign in</button>
    </div>
  </div>
</div>

<!-- ========================================================================
     Toast notifications
     ======================================================================== -->
<div id="toast" style="position:fixed; right:40px; bottom:40px; z-index:14000;"></div>

<!-- ========================================================================
     Footer with references
     ======================================================================== -->
<footer class="footer">
  <div class="container-lg text-center">
    <p class="f3">¬© 2026 ArcheoHub ‚Äî The Ultimate Archaeology Prototype</p>
    <p class="f5 muted">Built with passion for Kazakhstan's rich heritage</p>
    <p class="muted mt-6">Contact: <a href="mailto:shyn.aityk@gmail.com">shyn.aityk@gmail.com</a></p>
    <p class="small muted mt-8">
      References: 
      <a href="https://iie.kz" target="_blank">Institute of Archaeology Kazakhstan</a> ‚Ä¢ 
      <a href="https://e-history.kz" target="_blank">e-history.kz</a> ‚Ä¢ 
      <a href="https://whc.unesco.org" target="_blank">UNESCO World Heritage</a>
    </p>
  </div>
</footer>

<script>
// =============================================================================
// ArcheoHub ‚Äî Ultimate Prototype (2800+ lines of excellence)
// Author: Grok for Aityk
// Date: January 2026
// Location-inspired: Astana, Kazakhstan üá∞üáø
// =============================================================================

// --------------------------------------------------------------------------
// Core utilities
// --------------------------------------------------------------------------
function uid(prefix = 'id') {
  return prefix + '-' + Math.random().toString(36).substr(2, 10);
}

function now() {
  return new Date().toISOString();
}

function saveLS(key, value) {
  try {
    localStorage.setItem(key, JSON.stringify(value));
  } catch (e) {
    console.warn('LocalStorage save error:', e);
  }
}

function loadLS(key, def) {
  try {
    const v = localStorage.getItem(key);
    return v ? JSON.parse(v) : def;
  } catch (e) {
    return def;
  }
}

function toast(msg, duration = 4000) {
  const t = document.createElement('div');
  t.className = 'Box p-4 toast';
  t.style.background = '#1c2128';
  t.style.border = '1px solid #30363d';
  t.style.borderRadius = '12px';
  t.style.boxShadow = '0 8px 32px rgba(0,0,0,0.5)';
  t.style.minWidth = '300px';
  t.textContent = msg;
  document.getElementById('toast').appendChild(t);
  setTimeout(() => t.remove(), duration);
}

function safeOn(selector, event, handler) {
  const el = typeof selector === 'string' ? document.querySelector(selector) : selector;
  if (el) el.addEventListener(event, handler);
}

function escapeHTML(str) {
  if (!str) return '';
  return String(str)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#039;');
}

// --------------------------------------------------------------------------
// Formspree integration
// --------------------------------------------------------------------------
const FORMSPREE_ENDPOINT = 'https://formspree.io/f/xdakdvqo';
async function sendToFormspree(payload) {
  try {
    const res = await fetch(FORMSPREE_ENDPOINT, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Accept': 'application/json'
      },
      body: JSON.stringify({
        email: payload.email || '',
        repo: payload.repoPath,
        type: payload.type,
        title: payload.title,
        message: payload.desc,
        author: payload.author,
        time: payload.time,
        _subject: `ArcheoHub Finding: ${payload.title}`,
        _replyto: payload.email || ''
      })
    });
    return res.ok;
  } catch (err) {
    console.error('Formspree error:', err);
    return false;
  }
}

// --------------------------------------------------------------------------
// Application state
// --------------------------------------------------------------------------
const App = {
  theme: localStorage.getItem('theme') || 'dark',
  user: loadLS('archeo_user', null),
  repos: loadLS('archeo_repos', null),
  issues: loadLS('archeo_issues', null),
  prs: loadLS('archeo_prs', null),
  page: 'explore',
  currentRepoId: null,
  filter: {
    type: '',
    search: '',
    period: '',
    yearRange: [-3000, 2025]
  }
};
document.documentElement.setAttribute('data-color-mode', App.theme);

// --------------------------------------------------------------------------
// Data seeding ‚Äî 100 sites with real coordinates where possible
// --------------------------------------------------------------------------
if (!App.repos) {
  App.repos = [];

  const sites = [
    // Bronze Age (1-25)
    { name: "Semiyarka Bronze Age city", period: "Bronze Age", lat: 50.4, lon: 73.2 },
    { name: "Akbaur Cave paintings", period: "Bronze Age", lat: 48.9, lon: 75.3 },
    { name: "Ainabulak‚ÄìTemirsu burial", period: "Bronze Age", lat: 49.8, lon: 72.9 },
    { name: "Andronovo culture dwellings (Karaganda)", period: "Bronze Age", lat: 49.8, lon: 73.1 },
    { name: "Karazhartas Necropolis", period: "Bronze Age", lat: 48.5, lon: 73.8 },
    { name: "Tasmola culture barrows", period: "Bronze Age", lat: 50.1, lon: 71.5 },
    { name: "Boralday necropolis", period: "Bronze Age", lat: 43.3, lon: 76.9 },
    { name: "Shilikty Valley royal kurgans", period: "Bronze Age", lat: 47.4, lon: 82.1 },
    { name: "Eleke Sazy burial complexes", period: "Bronze Age", lat: 47.3367, lon: 82.1261 },
    { name: "Akkainar petroglyphs", period: "Bronze Age", lat: 44.2, lon: 76.8 },
    { name: "Zhartas petroglyphs", period: "Bronze Age", lat: 43.9, lon: 76.5 },
    { name: "Tamgaly petroglyphs", period: "Bronze Age", lat: 43.80333, lon: 75.53500 },
    { name: "Begazy-Dandybai mausoleums", period: "Bronze Age", lat: 48.8, lon: 73.5 },
    { name: "Kent Bronze Age settlement", period: "Bronze Age", lat: 49.2, lon: 73.8 },
    { name: "Atasu Bronze Age metallurgical site", period: "Bronze Age", lat: 48.7, lon: 73.4 },
    { name: "Myrzhyk Bronze Age burial ground", period: "Bronze Age", lat: 49.0, lon: 73.0 },
    { name: "Buguly I settlement", period: "Bronze Age", lat: 49.5, lon: 72.5 },
    { name: "Buguly II burial site", period: "Bronze Age", lat: 49.6, lon: 72.6 },
    { name: "Sherubai-Nura Bronze Age settlement", period: "Bronze Age", lat: 49.3, lon: 72.8 },
    { name: "Karaganda Bronze Age copper mines", period: "Bronze Age", lat: 49.8, lon: 73.0 },
    { name: "Ulytau ritual stone complexes", period: "Bronze Age", lat: 48.5, lon: 67.8 },
    { name: "Saryarka Bronze Age settlements", period: "Bronze Age", lat: 50.0, lon: 70.0 },
    { name: "Kokshetau Bronze Age burial mounds", period: "Bronze Age", lat: 53.3, lon: 69.4 },
    { name: "Zhezkazgan ancient mining complex", period: "Bronze Age", lat: 47.8, lon: 67.7 },
    { name: "Turgai Bronze Age sites", period: "Bronze Age", lat: 50.5, lon: 65.0 },
    // Saka/Scythian (26-55)
    { name: "Issyk kurgan (Golden Man)", period: "Saka/Scythian", lat: 43.36, lon: 77.46 },
    { name: "Araltobe Golden Man", period: "Saka/Scythian", lat: 47.2, lon: 81.8 },
    { name: "Shilikty Golden Man", period: "Saka/Scythian", lat: 47.4, lon: 82.0 },
    { name: "Eleke Sazy Golden Man", period: "Saka/Scythian", lat: 47.3367, lon: 82.1261 },
    { name: "Karabau-2 Sarmatian burial", period: "Saka/Scythian", lat: 50.8, lon: 58.5 },
    { name: "Togyzbulak Scythian burial mounds", period: "Saka/Scythian", lat: 48.0, lon: 80.0 },
    { name: "Toraygyr-7 Saka knives", period: "Saka/Scythian", lat: 47.5, lon: 81.5 },
    { name: "Berel kurgans (horse burials)", period: "Saka/Scythian", lat: 49.37389, lon: 86.42694 },
    { name: "Katon-Karagay Saka graves", period: "Saka/Scythian", lat: 49.2, lon: 86.5 },
    { name: "Baigetobe kurgan", period: "Saka/Scythian", lat: 47.8, lon: 81.2 },
    { name: "Mayemer Saka burial complex", period: "Saka/Scythian", lat: 43.5, lon: 77.0 },
    { name: "Saka ritual altars of Altai", period: "Saka/Scythian", lat: 49.0, lon: 87.0 },
    { name: "Sarmatian necropolis (Atyrau)", period: "Saka/Scythian", lat: 47.1, lon: 51.9 },
    { name: "Lebedevka Sarmatian site", period: "Saka/Scythian", lat: 50.5, lon: 58.0 },
    { name: "Prokhorovka culture graves", period: "Saka/Scythian", lat: 51.0, lon: 57.0 },
    { name: "Early nomad bronze cauldrons", period: "Saka/Scythian", lat: 48.0, lon: 82.0 },
    { name: "Saka animal-style gold plaques", period: "Saka/Scythian", lat: 47.0, lon: 81.0 },
    { name: "Scythian arrowheads of East Kazakhstan", period: "Saka/Scythian", lat: 49.9, lon: 82.6 },
    { name: "Saka ceremonial mirrors", period: "Saka/Scythian", lat: 47.3, lon: 81.7 },
    { name: "Gold belt fittings from Zhetysu", period: "Saka/Scythian", lat: 44.0, lon: 78.0 },
    { name: "Sarmatian swords (Akinakai)", period: "Saka/Scythian", lat: 47.0, lon: 80.0 },
    { name: "Horse harness decorations (gold)", period: "Saka/Scythian", lat: 49.4, lon: 86.4 },
    { name: "Saka burial masks", period: "Saka/Scythian", lat: 47.5, lon: 82.5 },
    { name: "Sarmatian pottery complexes", period: "Saka/Scythian", lat: 50.0, lon: 58.0 },
    { name: "Scythian bronze cauldrons", period: "Saka/Scythian", lat: 48.5, lon: 83.0 },
    { name: "Nomadic elite kurgans of Altai", period: "Saka/Scythian", lat: 49.5, lon: 87.0 },
    { name: "East Kazakhstan royal burial mounds", period: "Saka/Scythian", lat: 49.9, lon: 82.6 },
    { name: "Saka ceremonial fire altars", period: "Saka/Scythian", lat: 47.8, lon: 81.5 },
    { name: "Nomad warrior graves (West Kazakhstan)", period: "Saka/Scythian", lat: 49.0, lon: 52.0 },
    { name: "Early Iron Age ritual stone rings", period: "Saka/Scythian", lat: 48.0, lon: 70.0 },
    // Medieval Cities (56-80)
    { name: "Otrar (Farab)", period: "Medieval Cities", lat: 42.85148, lon: 68.30297 },
    { name: "Turkestan (Yassi)", period: "Medieval Cities", lat: 43.2977, lon: 68.2706 },
    { name: "Sauran", period: "Medieval Cities", lat: 43.5167, lon: 67.7667 },
    { name: "Taraz (Talas)", period: "Medieval Cities", lat: 42.9, lon: 71.3667 },
    { name: "Jankent", period: "Medieval Cities", lat: 45.5, lon: 59.0 },
    { name: "Balasagun", period: "Medieval Cities", lat: 42.75, lon: 75.25 },
    { name: "Kulan", period: "Medieval Cities", lat: 42.8, lon: 72.7 },
    { name: "Talgar (Talkhir)", period: "Medieval Cities", lat: 43.3, lon: 77.2 },
    { name: "Kayalyk (Antonovka)", period: "Medieval Cities", lat: 43.5, lon: 78.0 },
    { name: "Zhankala medieval city", period: "Medieval Cities", lat: 46.0, lon: 60.0 },
    { name: "Sumbe settlement", period: "Medieval Cities", lat: 44.0, lon: 68.0 },
    { name: "Aktobe medieval site", period: "Medieval Cities", lat: 50.3, lon: 57.2 },
    { name: "Akyrtas palace complex", period: "Medieval Cities", lat: 43.0, lon: 73.0 },
    { name: "Koilyk city ruins", period: "Medieval Cities", lat: 43.8, lon: 69.5 },
    { name: "Karatau Silk Road fortresses", period: "Medieval Cities", lat: 43.2, lon: 70.0 },
    { name: "Zhetysu caravanserai ruins", period: "Medieval Cities", lat: 44.5, lon: 78.0 },
    { name: "Steppe geoglyph complexes (Torgai)", period: "Medieval Cities", lat: 50.5, lon: 64.0 },
    { name: "Burned medieval city (Zhetysu)", period: "Medieval Cities", lat: 44.0, lon: 77.5 },
    { name: "Kimak Khaganate capital (Pavlodar region)", period: "Medieval Cities", lat: 52.3, lon: 76.9 },
    { name: "Kipchak settlements of Saryarka", period: "Medieval Cities", lat: 50.0, lon: 70.0 },
    { name: "Golden Horde city ruins", period: "Medieval Cities", lat: 48.0, lon: 60.0 },
    { name: "Medieval bathhouse ruins (Taraz)", period: "Medieval Cities", lat: 42.9, lon: 71.4 },
    { name: "Mosque foundations of Otrar", period: "Medieval Cities", lat: 42.85, lon: 68.3 },
    { name: "Necropolis of Turkestan", period: "Medieval Cities", lat: 43.3, lon: 68.27 },
    { name: "Defensive walls of Sauran", period: "Medieval Cities", lat: 43.52, lon: 67.77 },
    // Rock Art & Prehistoric (81-100)
    { name: "Arpa-Uzen petroglyphs", period: "Rock Art & Prehistoric", lat: 43.5, lon: 68.0 },
    { name: "Eshkiolmes petroglyphs", period: "Rock Art & Prehistoric", lat: 43.8, lon: 75.0 },
    { name: "Karatau rock art complexes", period: "Rock Art & Prehistoric", lat: 43.0, lon: 70.0 },
    { name: "Bayanzhurek petroglyphs", period: "Rock Art & Prehistoric", lat: 44.0, lon: 76.0 },
    { name: "Kulzhabasy petroglyphs", period: "Rock Art & Prehistoric", lat: 43.9, lon: 75.5 },
    { name: "Sauyskandyk petroglyphs", period: "Rock Art & Prehistoric", lat: 44.2, lon: 77.0 },
    { name: "Shakpakata cave sites", period: "Rock Art & Prehistoric", lat: 44.5, lon: 52.0 },
    { name: "Mangystau necropolis rock carvings", period: "Rock Art & Prehistoric", lat: 44.0, lon: 52.0 },
    { name: "Paleolithic site of Shulbinka", period: "Rock Art & Prehistoric", lat: 53.0, lon: 69.0 },
    { name: "Mesolithic sites of North Kazakhstan", period: "Rock Art & Prehistoric", lat: 54.0, lon: 69.0 },
    { name: "Neolithic settlements near Irtysh", period: "Rock Art & Prehistoric", lat: 52.0, lon: 77.0 },
    { name: "Eneolithic Botai culture settlement", period: "Rock Art & Prehistoric", lat: 53.19986, lon: 67.65605 },
    { name: "Botai horse domestication evidence", period: "Rock Art & Prehistoric", lat: 53.19986, lon: 67.65605 },
    { name: "Krasnyi Yar site", period: "Rock Art & Prehistoric", lat: 52.5, lon: 76.5 },
    { name: "Urpek settlement", period: "Rock Art & Prehistoric", lat: 50.0, lon: 70.0 },
    { name: "Dongtalede prehistoric site", period: "Rock Art & Prehistoric", lat: 48.0, lon: 80.0 },
    { name: "Ilibalyk archaeological site", period: "Rock Art & Prehistoric", lat: 44.0, lon: 78.0 },
    { name: "Bogen Reservoir submerged sites", period: "Rock Art & Prehistoric", lat: 52.0, lon: 76.0 },
    { name: "Stone tool workshops of Altai", period: "Rock Art & Prehistoric", lat: 49.0, lon: 87.0 },
    { name: "Early ritual stone alignments of Ulytau", period: "Rock Art & Prehistoric", lat: 48.5, lon: 67.8 }
  ];

  const periodColors = {
    "Bronze Age": "var(--bronze)",
    "Saka/Scythian": "var(--saka)",
    "Medieval Cities": "var(--medieval)",
    "Rock Art & Prehistoric": "var(--prehistoric)"
  };

  const authors = ["Dr. A. Abayev", "Prof. K. Baipakov", "Dr. Z. Samashev", "A. Ongar", "S. Azhigali", "E. Smagulov", "T. Nurumov", "A. Toleubayeva"];
  const messages = [
    "Trench excavation completed", "Portable XRF analysis results", "Radiocarbon samples processed",
    "Stratigraphy profile documented", "Artifact conservation treatment", "Geophysical survey completed",
    "Petroglyph panel recorded", "Kurgan fully excavated", "Golden artifact detailed study",
    "Horse burial permafrost analysis", "New cultural layer discovered", "3D photogrammetry scan",
    "Soil samples analyzed", "New petroglyph panel found", "Bronze artifact cataloged"
  ];

  sites.forEach((site, index) => {
    const commits = [];
    const commitCount = Math.floor(Math.random() * 15) + 10;

    for (let c = 0; c < commitCount; c++) {
      const year = -3000 + Math.floor(Math.pow(Math.random(), 0.9) * (2025 + 3000));
      const layerCount = Math.floor(Math.random() * 8) + 3;
      const layers = [];

      for (let l = 0; l < layerCount; l++) {
        layers.push({
          id: uid('layer'),
          name: `Layer ${l + 1} - ${['Topsoil', 'Cultural Layer', 'Sterile Soil', 'Grave Fill', 'Ritual Deposit', 'Hearth'][Math.floor(Math.random() * 6)]}`,
          thickness: Math.round(Math.random() * 80 + 10),
          color: ['#c2a97f', '#8fbf9f', '#c27ba0', '#7fa7d9', '#d9a7c7', '#f0c9a1', '#a8d9a7'][Math.floor(Math.random() * 7)],
          notes: "Detailed field observations and sample references..."
        });
      }

      commits.push({
        id: uid('commit'),
        author: authors[Math.floor(Math.random() * authors.length)],
        year: year,
        type: ["Discovery", "Analysis", "Theory", "Preservation", "Maintenance"][Math.floor(Math.random() * 5)],
        message: messages[Math.floor(Math.random() * messages.length)],
        layers: layers
      });
    }

    commits.sort((a, b) => a.year - b.year);

    App.repos.push({
      id: String(index + 1),
      name: site.name,
      site: site.name,
      country: "Kazakhstan",
      period: site.period,
      periodColor: periodColors[site.period],
      lat: site.lat,
      lon: site.lon,
      image: "https://images.unsplash.com/photo-1581093450021-4a7360e9a6b5?q=80&w=1600&auto=format&fit=crop",
      commits: commits,
      branches: [],
      stars: Math.floor(Math.random() * 12000),
      forks: Math.floor(Math.random() * 2500),
      owner: 'community',
      watched: false
    });
  });

  saveLS('archeo_repos', App.repos);
}

// --------------------------------------------------------------------------
// Issues & PRs initial seeding
// --------------------------------------------------------------------------
if (!App.issues) {
  App.issues = [
    {
      id: uid('iss'),
      title: "Golden Man armor reconstruction debate",
      repoId: App.repos.find(r => r.name.includes("Issyk"))?.id || "26",
      status: "inprogress",
      author: "Dr. Z. Samashev",
      created: now(),
      comments: []
    },
    {
      id: uid('iss'),
      title: "Tamgaly petroglyph dating refinement needed",
      repoId: App.repos.find(r => r.name.includes("Tamgaly"))?.id || "12",
      status: "todo",
      author: "A. Ongar",
      created: now(),
      comments: []
    }
  ];
  saveLS('archeo_issues', App.issues);
}

if (!App.prs) {
  App.prs = [
    {
      id: uid('pr'),
      title: "Add new 3D model of Berel horse burial",
      repoId: App.repos.find(r => r.name.includes("Berel"))?.id || "33",
      author: "Prof. K. Baipakov",
      created: now(),
      status: "open",
      description: "Updated permafrost preservation data"
    }
  ];
  saveLS('archeo_prs', App.prs);
}

// --------------------------------------------------------------------------
// Navigation & routing
// --------------------------------------------------------------------------
function navigate(page, opts = {}) {
  App.page = page;
  if (opts.repoId) App.currentRepoId = opts.repoId;
  try {
    history.pushState({ page, opts }, '', `#${page}${opts.repoId ? '-' + opts.repoId : ''}`);
  } catch (e) {}
  render();
}

window.addEventListener('popstate', () => {
  const hash = window.location.hash.slice(1);
  if (!hash) {
    App.page = 'explore';
    App.currentRepoId = null;
  } else {
    const parts = hash.split('-');
    App.page = parts[0] || 'explore';
    App.currentRepoId = parts[1] || null;
  }
  render();
});

// --------------------------------------------------------------------------
// Auth & profile helpers
// --------------------------------------------------------------------------
function setUser(user) {
  App.user = user;
  saveLS('archeo_user', user);
  updateHeaderAuth();
}

function signOut() {
  App.user = null;
  localStorage.removeItem('archeo_user');
  updateHeaderAuth();
  toast('Signed out successfully');
}

function updateHeaderAuth() {
  const avatar = document.getElementById('avatar-img');
  const emailEl = document.getElementById('user-email');
  if (App.user) {
    const initials = (App.user.displayName || App.user.email)
      .split(' ')
      .map(s => s[0])
      .slice(0, 2)
      .join('')
      .toUpperCase();
    avatar.src = `https://avatars.dicebear.com/api/initials/${encodeURIComponent(initials)}.svg`;
    emailEl.textContent = App.user.email;
  } else {
    avatar.src = 'https://avatars.githubusercontent.com/u/0?v=4';
    emailEl.textContent = 'guest';
  }
}

// --------------------------------------------------------------------------
// Delete helpers for issues/PRs
// --------------------------------------------------------------------------
function deleteIssue(id) {
  const idx = App.issues.findIndex(i => i.id === id);
  if (idx === -1) return;
  if (!confirm('Delete this issue permanently?')) return;
  App.issues.splice(idx, 1);
  saveLS('archeo_issues', App.issues);
  toast('Issue deleted');
  render();
}

function deletePR(id) {
  const idx = App.prs.findIndex(p => p.id === id);
  if (idx === -1) return;
  if (!confirm('Delete this pull request permanently?')) return;
  App.prs.splice(idx, 1);
  saveLS('archeo_prs', App.prs);
  toast('Pull request deleted');
  render();
}

// --------------------------------------------------------------------------
// Event wiring ‚Äî Auth, theme, modals, new finding
// --------------------------------------------------------------------------
safeOn('#auth-submit', 'click', () => {
  const email = document.getElementById('auth-email').value.trim();
  const name = document.getElementById('auth-name').value.trim();
  if (!email || !email.endsWith('@gmail.com')) {
    alert('Please use a @gmail.com address for this demo');
    return;
  }
  const user = {
    email,
    displayName: name || email.split('@')[0],
    bio: '',
    website: ''
  };
  setUser(user);
  document.getElementById('auth-modal').hidden = true;
  toast(`Welcome, ${user.displayName}!`);
});

safeOn('#auth-close', 'click', () => {
  document.getElementById('auth-modal').hidden = true;
});

safeOn('#logout-btn', 'click', () => signOut());

document.querySelectorAll('details summary').forEach(summary => {
  summary.addEventListener('click', e => {
    if (!App.user) {
      e.preventDefault();
      document.getElementById('auth-modal').hidden = false;
    }
  });
});

safeOn('#theme-toggle', 'click', () => {
  App.theme = App.theme === 'dark' ? 'light' : 'dark';
  document.documentElement.setAttribute('data-color-mode', App.theme);
  localStorage.setItem('theme', App.theme);
  toast(`Theme switched to ${App.theme}`);
});

safeOn('#new-finding-btn', 'click', () => {
  document.getElementById('new-finding-modal').hidden = false;
});

safeOn('#close-new-finding', 'click', () => {
  document.getElementById('new-finding-modal').hidden = true;
});

safeOn('#submit-finding', 'click', async () => {
  const form = document.getElementById('new-finding-form');
  const repoPath = form.repo.value.trim();
  const title = form.title.value.trim();
  const type = form.type.value;
  const desc = form.desc.value.trim();
  const email = form.submitterEmail.value.trim() || (App.user ? App.user.email : '');

  if (!repoPath || !title) {
    alert('Repository path and title are required');
    return;
  }

  let repo = App.repos.find(r => r.name.toLowerCase() === repoPath.toLowerCase());
  if (!repo) {
    const newLat = 48 + (Math.random() - 0.5) * 8;
    const newLon = 70 + (Math.random() - 0.5) * 20;
    repo = {
      id: String(App.repos.length + 1),
      name: repoPath,
      site: repoPath.split('/').pop(),
      country: "Kazakhstan",
      period: "User Added",
      periodColor: "#0366d6",
      lat: newLat,
      lon: newLon,
      image: "https://images.unsplash.com/photo-1581093450021-4a7360e9a6b5?q=80&w=1600",
      commits: [],
      branches: [],
      stars: 0,
      forks: 0,
      owner: App.user ? App.user.displayName : 'guest'
    };
    App.repos.unshift(repo);
  }

  const newCommit = {
    id: uid('commit'),
    author: App.user ? App.user.displayName : 'guest',
    year: new Date().getFullYear(),
    type: type,
    message: title,
    layers: [{
      id: uid('layer'),
      name: "New user layer",
      thickness: 25,
      color: "#58a6ff",
      notes: desc
    }]
  };
  repo.commits.push(newCommit);
  saveLS('archeo_repos', App.repos);

  const payload = {
    repoPath,
    title,
    type,
    desc,
    author: App.user ? App.user.displayName : 'guest',
    email,
    time: now()
  };

  const btn = document.getElementById('submit-finding');
  btn.disabled = true;
  btn.textContent = 'Sending...';

  const emailOk = await sendToFormspree(payload);

  btn.disabled = false;
  btn.textContent = 'Submit & Send Email';

  toast(emailOk ? 'Finding submitted and emailed!' : 'Finding saved locally (email failed)');
  document.getElementById('new-finding-modal').hidden = true;
  render();
});

// --------------------------------------------------------------------------
// Render functions ‚Äî Core UI
// --------------------------------------------------------------------------
function repoCardHTML(repo) {
  const latest = repo.commits[repo.commits.length - 1];
  return `
    <div class="Box-row">
      <div style="flex:1;">
        <div class="d-flex flex-items-center gap-3 mb-2">
          <a href="#" class="repo-title" data-route="repo" data-repo="${repo.id}">${escapeHTML(repo.name)}</a>
          <span class="Label" style="background:${repo.periodColor};">${escapeHTML(repo.period)}</span>
        </div>
        <div class="small muted">Kazakhstan ‚Ä¢ ${repo.commits.length} commits ‚Ä¢ ${repo.stars} stars</div>
        <div class="small muted mt-2">${latest ? `${latest.type} ‚Ä¢ ${latest.year} ‚Ä¢ ${escapeHTML(latest.message)}` : 'No commits yet'}</div>
      </div>
      <div class="text-right">
        <div class="d-flex flex-column gap-3 align-items-end">
          <div class="small muted">‚òÖ ${repo.stars} | ‚áÑ ${repo.forks}</div>
          <div class="d-flex gap-3">
            <button class="btn btn-sm btn-ghost" data-action="watch" data-id="${repo.id}">${repo.watched ? '‚òÖ Watching' : 'Watch'}</button>
            <button class="btn btn-sm btn-ghost" data-action="star" data-id="${repo.id}">Star</button>
            <button class="btn btn-sm btn-primary" data-action="open" data-id="${repo.id}">Open ‚Üí</button>
          </div>
        </div>
      </div>
    </div>
  `;
}

function render() {
  updateHeaderAuth();
  const root = document.getElementById('app-root');
  if (!root) return;

  root.innerHTML = '';

  // Global search handler
  const searchInput = document.getElementById('global-search');
  if (searchInput) {
    searchInput.onkeypress = e => {
      if (e.key === 'Enter') {
        App.filter.search = e.target.value.trim();
        navigate('explore');
      }
    };
  }

  if (App.page === 'explore') renderExplore(root);
  else if (App.page === 'map') renderMap(root);
  else if (App.page === 'repo') renderRepo(root, App.currentRepoId);
  else if (App.page === 'profile') renderProfile(root);
  else if (App.page === 'issues') renderIssuesBoard(root);
  else if (App.page === 'prs') renderPRList(root);
  else renderExplore(root);
}

// --------------------------------------------------------------------------
// Explore view with period filter
// --------------------------------------------------------------------------
function renderExplore(root) {
  root.innerHTML = `
    <div class="two-col">
      <div>
        <div class="Box mb-6">
          <div class="Box-title">Explore 100 Archaeological Sites of Kazakhstan</div>
          <div id="repo-list" class="Box-body p-0"></div>
        </div>
        <div class="Box">
          <div class="Box-title">Timeline Filter</div>
          <div class="Box-body">
            <div id="timeline"></div>
            <div class="small muted mt-4">Drag to filter commits by year range</div>
          </div>
        </div>
      </div>
      <aside>
        <div class="Box mb-6">
          <div class="Box-title">Filters</div>
          <div class="Box-body">
            <label class="f5 mb-2">Period</label>
            <select id="filter-period" class="form-select form-select-lg mb-4">
              <option value="">All periods</option>
              <option value="Bronze Age">Bronze Age</option>
              <option value="Saka/Scythian">Saka/Scythian</option>
              <option value="Medieval Cities">Medieval Cities</option>
              <option value="Rock Art & Prehistoric">Rock Art & Prehistoric</option>
            </select>
            <label class="f5 mb-2">Commit type</label>
            <select id="filter-type" class="form-select form-select-lg mb-4">
              <option value="">All types</option>
              <option>Discovery</option>
              <option>Analysis</option>
              <option>Theory</option>
              <option>Preservation</option>
              <option>Maintenance</option>
            </select>
            <label class="f5 mb-2">Search</label>
            <input id="filter-search" class="form-control form-control-lg mb-4" placeholder="Site name, artifact..." />
            <button id="apply-filters" class="btn btn-primary w-100 btn-lg">Apply Filters</button>
          </div>
        </div>
        <div class="Box">
          <div class="Box-title">Quick Actions</div>
          <div class="Box-body">
            <button id="open-map" class="btn btn-ghost w-100 mb-3 btn-lg">View Map</button>
            <button id="open-issues" class="btn btn-ghost w-100 btn-lg">Issues Board</button>
          </div>
        </div>
      </aside>
    </div>
  `;

  const list = document.getElementById('repo-list');

  function filterAndRender() {
    const [minYear, maxYear] = App.filter.yearRange;
    let filtered = App.repos.filter(repo => {
      if (!repo.commits.some(c => c.year >= minYear && c.year <= maxYear)) return false;
      if (App.filter.period && repo.period !== App.filter.period) return false;
      if (App.filter.type && !repo.commits.some(c => c.type === App.filter.type)) return false;
      if (App.filter.search) {
        const search = App.filter.search.toLowerCase();
        if (!repo.name.toLowerCase().includes(search) && !repo.period.toLowerCase().includes(search)) return false;
      }
      return true;
    });

    filtered.sort((a, b) => b.stars - a.stars);

    list.innerHTML = filtered.map(repoCardHTML).join('');

    // Event delegation for buttons
    list.querySelectorAll('[data-action="open"]').forEach(btn => {
      btn.addEventListener('click', e => {
        e.stopPropagation();
        navigate('repo', { repoId: btn.dataset.id });
      });
    });

    list.querySelectorAll('[data-action="star"]').forEach(btn => {
      btn.addEventListener('click', e => {
        e.stopPropagation();
        const repo = App.repos.find(r => r.id === btn.dataset.id);
        if (repo) {
          repo.stars++;
          saveLS('archeo_repos', App.repos);
          toast('Starred!');
          filterAndRender();
        }
      });
    });

    list.querySelectorAll('[data-action="watch"]').forEach(btn => {
      btn.addEventListener('click', e => {
        e.stopPropagation();
        const repo = App.repos.find(r => r.id === btn.dataset.id);
        if (repo) {
          repo.watched = !repo.watched;
          saveLS('archeo_repos', App.repos);
          toast(repo.watched ? 'Now watching this repo' : 'Stopped watching');
          filterAndRender();
        }
      });
    });

    list.querySelectorAll('a[data-route="repo"]').forEach(a => {
      a.addEventListener('click', e => {
        e.preventDefault();
        navigate('repo', { repoId: a.dataset.repo });
      });
    });
  }

  // Timeline slider
  const timelineEl = document.getElementById('timeline');
  timelineEl.innerHTML = '<div id="time-slider" style="margin:20px 0;"></div>';
  const slider = document.getElementById('time-slider');
  if (typeof noUiSlider !== 'undefined') {
    noUiSlider.create(slider, {
      start: App.filter.yearRange,
      connect: true,
      range: { min: -3000, max: 2025 },
      step: 10,
      tooltips: [true, true],
      format: { to: v => Math.round(v), from: v => Number(v) }
    });
    slider.noUiSlider.on('update', values => {
      App.filter.yearRange = [Number(values[0]), Number(values[1])];
      filterAndRender();
    });
  }

  // Filter controls
  const periodSelect = document.getElementById('filter-period');
  const typeSelect = document.getElementById('filter-type');
  const searchInput = document.getElementById('filter-search');

  periodSelect.value = App.filter.period;
  typeSelect.value = App.filter.type;
  searchInput.value = App.filter.search;

  safeOn('#apply-filters', 'click', () => {
    App.filter.period = periodSelect.value;
    App.filter.type = typeSelect.value;
    App.filter.search = searchInput.value.trim();
    filterAndRender();
  });

  filterAndRender();
}

// --------------------------------------------------------------------------
// Map view with clustering and legend
// --------------------------------------------------------------------------
function renderMap(root) {
  root.innerHTML = `
    <div class="Box">
      <div class="Box-title">Interactive Map ‚Äî 100 Archaeological Sites of Kazakhstan</div>
      <div class="Box-body p-0">
        <div id="map"></div>
        <div class="legend">
          <div class="f5 mb-4">Period Legend</div>
          <div class="legend-item"><div class="legend-color" style="background:var(--bronze);"></div> Bronze Age</div>
          <div class="legend-item"><div class="legend-color" style="background:var(--saka);"></div> Saka/Scythian</div>
          <div class="legend-item"><div class="legend-color" style="background:var(--medieval);"></div> Medieval Cities</div>
          <div class="legend-item"><div class="legend-color" style="background:var(--prehistoric);"></div> Rock Art & Prehistoric</div>
        </div>
      </div>
    </div>
  `;

  const mapEl = document.getElementById('map');
  if (typeof L === 'undefined') {
    mapEl.innerHTML = '<div class="p-6 text-center muted">Map library not loaded</div>';
    return;
  }

  const map = L.map(mapEl).setView([48, 70], 5);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  const markers = L.markerClusterGroup();

  const bounds = [];

  App.repos.forEach(repo => {
    if (!repo.lat || !repo.lon) return;

    const icon = L.divIcon({
      className: 'custom-marker',
      html: `<div style="background:${repo.periodColor}; width:16px; height:16px; border-radius:50%; border:3px solid #fff; box-shadow:0 2px 8px rgba(0,0,0,0.5);"></div>`,
      iconSize: [16, 16]
    });

    const marker = L.marker([repo.lat, repo.lon], { icon });
    marker.bindPopup(`
      <div style="min-width:240px;">
        <strong class="f4">${escapeHTML(repo.name)}</strong><br>
        <span class="Label" style="background:${repo.periodColor};">${escapeHTML(repo.period)}</span><br>
        <div class="small muted mt-2">${repo.commits.length} commits ‚Ä¢ ${repo.stars} stars</div>
        <button class="btn btn-primary btn-sm mt-3 w-100" onclick="navigate('repo',{repoId:'${repo.id}'})">Open Repository</button>
      </div>
    `);
    markers.addLayer(marker);
    bounds.push([repo.lat, repo.lon]);
  });

  map.addLayer(markers);

  if (bounds.length > 0) {
    map.fitBounds(L.latLngBounds(bounds).pad(0.2));
  }
}

// --------------------------------------------------------------------------
// Repository view ‚Äî Tabs, commits, 3D, export
// --------------------------------------------------------------------------
function renderRepo(root, repoId) {
  const repo = App.repos.find(r => r.id === repoId) || App.repos[0];
  if (!repo) return renderExplore(root);

  App.currentRepoId = repo.id;

  root.innerHTML = `
    <div class="two-col">
      <div>
        <div class="Box mb-6">
          <div class="Box-body p-5">
            <div class="d-flex flex-justify-between flex-items-start">
              <div>
                <h1 class="f00-light mb-3">${escapeHTML(repo.name)}</h1>
                <div class="d-flex flex-items-center gap-4 mb-4">
                  <span class="Label" style="background:${repo.periodColor}; font-size:1rem; padding:8px 16px;">${escapeHTML(repo.period)}</span>
                  <span class="small muted">Kazakhstan ‚Ä¢ ${repo.commits.length} commits</span>
                </div>
                <div class="d-flex gap-5">
                  <div>‚òÖ ${repo.stars} stars</div>
                  <div>‚áÑ ${repo.forks} forks</div>
                  <div>${repo.watched ? '‚òÖ Watching' : '‚óã Not watching'}</div>
                </div>
              </div>
              <div class="d-flex gap-4">
                <button id="repo-watch" class="btn btn-ghost btn-lg">${repo.watched ? '‚òÖ Watching' : 'Watch'}</button>
                <button id="repo-star" class="btn btn-ghost btn-lg">Star</button>
                <button id="repo-fork" class="btn btn-primary btn-lg">Fork</button>
              </div>
            </div>
          </div>
        </div>

        <div class="Box mb-6">
          <div class="tabs mb-0">
            <div class="tab selected" data-tab="code">Code & Commits</div>
            <div class="tab" data-tab="issues">Issues</div>
            <div class="tab" data-tab="prs">Pull Requests</div>
            <div class="tab" data-tab="timeline">Timeline</div>
          </div>
          <div id="repo-tab-content" class="Box-body"></div>
        </div>
      </div>
      <aside>
        <div class="Box mb-6">
          <div class="Box-title">Repository Actions</div>
          <div class="Box-body">
            <button id="open-3d-latest" class="btn btn-primary w-100 mb-4 btn-lg">View Latest Commit in 3D</button>
            <button id="export-csv" class="btn btn-ghost w-100 mb-4 btn-lg">Export Commits as CSV</button>
            <button id="export-json" class="btn btn-ghost w-100 btn-lg">Export Repository as JSON</button>
          </div>
        </div>
        <div class="Box">
          <div class="Box-title">Recent Activity</div>
          <div id="recent-commits" class="Box-body"></div>
        </div>
      </aside>
    </div>
  `;

  // Tab switching
  document.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', () => {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('selected'));
      tab.classList.add('selected');
      loadRepoTab(tab.dataset.tab, repo);
    });
  });

  loadRepoTab('code', repo);

  // Recent commits sidebar
  const recent = document.getElementById('recent-commits');
  recent.innerHTML = repo.commits.slice(-8).reverse().map(c => `
    <div class="mb-4 pb-4 border-bottom border-gray-dark">
      <div class="f5">${escapeHTML(c.message)}</div>
      <div class="small muted mt-1">${c.author} ‚Ä¢ ${c.year} ‚Ä¢ ${c.type}</div>
    </div>
  `).join('');

  // Action buttons
  safeOn('#repo-star', 'click', () => {
    repo.stars++;
    saveLS('archeo_repos', App.repos);
    toast('Starred!');
    renderRepo(root, repoId);
  });

  safeOn('#repo-watch', 'click', () => {
    repo.watched = !repo.watched;
    saveLS('archeo_repos', App.repos);
    toast(repo.watched ? 'Now watching this repository' : 'Stopped watching');
    renderRepo(root, repoId);
  });

  safeOn('#repo-fork', 'click', () => {
    const forkName = `${App.user?.displayName || 'guest'}-fork-${repo.branches.length + 1}`;
    repo.branches.push({
      name: forkName,
      commits: JSON.parse(JSON.stringify(repo.commits))
    });
    repo.forks++;
    saveLS('archeo_repos', App.repos);
    toast(`Fork created: ${forkName}`);
  });

  safeOn('#open-3d-latest', 'click', () => {
    const latest = repo.commits[repo.commits.length - 1];
    if (latest) open3DViewer(repo, latest);
  });

  // Export functions
  safeOn('#export-csv', 'click', () => exportRepoCSV(repo));
  safeOn('#export-json', 'click', () => exportRepoJSON(repo));
}

// --------------------------------------------------------------------------
// Repo tab content loader
// --------------------------------------------------------------------------
function loadRepoTab(tab, repo) {
  const content = document.getElementById('repo-tab-content');
  if (!content) return;

  if (tab === 'code') {
    content.innerHTML = `
      <div class="p-5">
        <h3>Commit History</h3>
        <div class="mt-4">
          ${repo.commits.slice().reverse().map(c => `
            <div class="Box-row">
              <div style="flex:1;">
                <div class="f5 mb-2">${escapeHTML(c.message)}</div>
                <div class="small muted">${c.author} ‚Ä¢ ${c.year} ‚Ä¢ ${c.type}</div>
              </div>
              <div class="d-flex gap-3">
                <button class="btn btn-sm btn-ghost btn-diff" data-commit="${c.id}">Diff</button>
                <button class="btn btn-sm btn-primary btn-3d" data-commit="${c.id}">3D View</button>
              </div>
            </div>
          `).join('')}
        </div>
      </div>
    `;

    content.querySelectorAll('.btn-3d').forEach(btn => {
      btn.addEventListener('click', () => {
        const commit = repo.commits.find(c => c.id === btn.dataset.commit);
        open3DViewer(repo, commit);
      });
    });

    content.querySelectorAll('.btn-diff').forEach(btn => {
      btn.addEventListener('click', () => openDiffChooser(repo, btn.dataset.commit));
    });
  } else if (tab === 'issues') {
    const repoIssues = App.issues.filter(i => i.repoId === repo.id);
    content.innerHTML = `
      <div class="p-5">
        <div class="d-flex flex-justify-between mb-5">
          <h3>Issues</h3>
          <button id="new-issue" class="btn btn-primary">New Issue</button>
        </div>
        ${repoIssues.length ? repoIssues.map(i => `
          <div class="Box mb-4">
            <div class="p-4">
              <div class="d-flex flex-justify-between">
                <div>
                  <div class="f4 mb-2">${escapeHTML(i.title)}</div>
                  <div class="small muted">${i.author} ‚Ä¢ ${i.status}</div>
                </div>
                <button class="btn btn-sm btn-ghost btn-delete-issue" data-id="${i.id}">Delete</button>
              </div>
            </div>
          </div>
        `).join('') : '<p class="muted">No issues yet</p>'}
      </div>
    `;

    safeOn('#new-issue', 'click', () => {
      const title = prompt('Issue title:');
      if (!title) return;
      const issue = {
        id: uid('iss'),
        title,
        repoId: repo.id,
        status: 'todo',
        author: App.user ? App.user.displayName : 'guest',
        created: now(),
        comments: []
      };
      App.issues.push(issue);
      saveLS('archeo_issues', App.issues);
      loadRepoTab('issues', repo);
      toast('Issue created');
    });

    content.querySelectorAll('.btn-delete-issue').forEach(btn => {
      btn.addEventListener('click', () => deleteIssue(btn.dataset.id));
    });
  } else if (tab === 'prs') {
    const repoPRs = App.prs.filter(p => p.repoId === repo.id);
    content.innerHTML = `
      <div class="p-5">
        <div class="d-flex flex-justify-between mb-5">
          <h3>Pull Requests</h3>
          <button id="new-pr" class="btn btn-primary">New PR</button>
        </div>
        ${repoPRs.length ? repoPRs.map(p => `
          <div class="Box mb-4">
            <div class="p-4">
              <div class="d-flex flex-justify-between">
                <div>
                  <div class="f4 mb-2">${escapeHTML(p.title)}</div>
                  <div class="small muted">${p.author} ‚Ä¢ ${p.status}</div>
                </div>
                <div class="d-flex gap-3">
                  <button class="btn btn-sm btn-primary btn-merge" data-id="${p.id}">Merge</button>
                  <button class="btn btn-sm btn-ghost btn-delete-pr" data-id="${p.id}">Delete</button>
                </div>
              </div>
            </div>
          </div>
        `).join('') : '<p class="muted">No pull requests yet</p>'}
      </div>
    `;

    safeOn('#new-pr', 'click', () => {
      const title = prompt('PR title:');
      if (!title) return;
      const pr = {
        id: uid('pr'),
        title,
        repoId: repo.id,
        author: App.user ? App.user.displayName : 'guest',
        created: now(),
        status: 'open',
        description: ''
      };
      App.prs.push(pr);
      saveLS('archeo_prs', App.prs);
      loadRepoTab('prs', repo);
      toast('PR created');
    });

    content.querySelectorAll('.btn-merge').forEach(btn => {
      btn.addEventListener('click', () => mergePR(btn.dataset.id, repo));
    });

    content.querySelectorAll('.btn-delete-pr').forEach(btn => {
      btn.addEventListener('click', () => deletePR(btn.dataset.id));
    });
  } else if (tab === 'timeline') {
    content.innerHTML = `
      <div class="p-5">
        <h3>Commit Timeline</h3>
        <div id="repo-timeline" class="mt-5"></div>
        <div id="timeline-commits" class="mt-6"></div>
      </div>
    `;

    const years = repo.commits.map(c => c.year);
    const minY = Math.min(...years);
    const maxY = Math.max(...years);

    const timelineEl = document.getElementById('repo-timeline');
    timelineEl.innerHTML = '<div id="repo-slider"></div>';

    const slider = document.getElementById('repo-slider');
    if (typeof noUiSlider !== 'undefined') {
      noUiSlider.create(slider, {
        start: [minY, maxY],
        connect: true,
        range: { min: minY, max: maxY },
        step: 1,
        tooltips: [true, true]
      });

      slider.noUiSlider.on('update', values => {
        const from = Math.round(values[0]);
        const to = Math.round(values[1]);
        const filtered = repo.commits.filter(c => c.year >= from && c.year <= to).reverse();

        document.getElementById('timeline-commits').innerHTML = filtered.map(c => `
          <div class="Box mb-4">
            <div class="p-4">
              <div class="f5 mb-2">${escapeHTML(c.message)}</div>
              <div class="small muted mb-3">${c.author} ‚Ä¢ ${c.year} ‚Ä¢ ${c.type}</div>
              <div class="d-flex gap-3">
                <button class="btn btn-sm btn-ghost btn-diff" data-commit="${c.id}">View Diff</button>
                <button class="btn btn-sm btn-primary btn-3d" data-commit="${c.id}">3D View</button>
              </div>
            </div>
          </div>
        `).join('');

        document.querySelectorAll('#timeline-commits .btn-3d').forEach(btn => {
          btn.addEventListener('click', () => {
            const commit = repo.commits.find(c => c.id === btn.dataset.commit);
            open3DViewer(repo, commit);
          });
        });

        document.querySelectorAll('#timeline-commits .btn-diff').forEach(btn => {
          btn.addEventListener('click', () => openDiffChooser(repo, btn.dataset.commit));
        });
      });
    }
  }
}

// --------------------------------------------------------------------------
// PR merge
// --------------------------------------------------------------------------
function mergePR(prId, repo) {
  const pr = App.prs.find(p => p.id === prId);
  if (!pr || !confirm(`Merge "${pr.title}" into ${repo.name}?`)) return;

  const mergeCommit = {
    id: uid('commit'),
    author: pr.author,
    year: new Date().getFullYear(),
    type: 'Maintenance',
    message: `Merge PR: ${pr.title}`,
    layers: repo.commits[repo.commits.length - 1]?.layers || []
  };
  repo.commits.push(mergeCommit);
  pr.status = 'merged';
  saveLS('archeo_repos', App.repos);
  saveLS('archeo_prs', App.prs);
  toast('PR merged successfully!');
  render();
}

// --------------------------------------------------------------------------
// Diff viewer
// --------------------------------------------------------------------------
function openDiffChooser(repo, selectedId) {
  const overlay = document.createElement('div');
  overlay.className = 'overlay';
  overlay.innerHTML = `
    <div class="card-dark" style="width:800px;">
      <h3 class="mb-5">Compare Commits</h3>
      <div class="d-flex gap-5">
        <div style="flex:1;">
          <label>Base commit</label>
          <select id="diff-base" class="form-select form-select-lg">
            ${repo.commits.map(c => `<option value="${c.id}" ${c.id === selectedId ? 'selected' : ''}>${c.year} ‚Äî ${c.type} ‚Äî ${escapeHTML(c.message)}</option>`).join('')}
          </select>
        </div>
        <div style="flex:1;">
          <label>Compare commit</label>
          <select id="diff-compare" class="form-select form-select-lg">
            ${repo.commits.map(c => `<option value="${c.id}">${c.year} ‚Äî ${c.type} ‚Äî ${escapeHTML(c.message)}</option>`).join('')}
          </select>
        </div>
      </div>
      <div class="mt-6 text-right">
        <button id="do-diff" class="btn btn-primary btn-lg">Compare</button>
      </div>
    </div>
  `;
  document.body.appendChild(overlay);

  overlay.addEventListener('click', e => {
    if (e.target === overlay) overlay.remove();
  });

  document.getElementById('do-diff').addEventListener('click', () => {
    const baseId = document.getElementById('diff-base').value;
    const compareId = document.getElementById('diff-compare').value;
    overlay.remove();
    const base = repo.commits.find(c => c.id === baseId);
    const compare = repo.commits.find(c => c.id === compareId);
    showDiff(base, compare, repo);
  });
}

function showDiff(base, compare, repo) {
  const added = compare.layers.filter(l => !base.layers.some(bl => bl.name === l.name));
  const removed = base.layers.filter(l => !compare.layers.some(cl => cl.name === l.name));

  const overlay = document.createElement('div');
  overlay.className = 'overlay';
  overlay.innerHTML = `
    <div class="card-dark" style="width:1100px;">
      <div class="d-flex flex-justify-between mb-5">
        <h2>Diff: ${escapeHTML(base.message)} ‚Üí ${escapeHTML(compare.message)}</h2>
        <button class="btn btn-ghost btn-lg" id="close-diff">‚úï</button>
      </div>
      <div class="d-flex gap-8">
        <div style="flex:1;">
          <h3>Base (${base.year})</h3>
          ${base.layers.map(l => `
            <div class="Box mb-3 p-4 ${removed.some(r => r.name === l.name) ? 'opacity-50' : ''}">
              <strong>${escapeHTML(l.name)}</strong> ‚Äî ${l.thickness}cm
              <div class="small muted mt-2">${escapeHTML(l.notes)}</div>
            </div>
          `).join('')}
        </div>
        <div style="flex:1;">
          <h3>Compare (${compare.year})</h3>
          ${compare.layers.map(l => `
            <div class="Box mb-3 p-4 ${added.some(a => a.name === l.name) ? 'border-green' : ''}">
              <strong>${escapeHTML(l.name)}</strong> ‚Äî ${l.thickness}cm
              <div class="small muted mt-2">${escapeHTML(l.notes)}</div>
            </div>
          `).join('')}
        </div>
      </div>
      <div class="mt-6 text-right">
        <button id="view-3d-compare" class="btn btn-primary btn-lg">View Compare Commit in 3D</button>
      </div>
    </div>
  `;
  document.body.appendChild(overlay);

  overlay.querySelector('#close-diff').addEventListener('click', () => overlay.remove());
  overlay.querySelector('#view-3d-compare').addEventListener('click', () => {
    overlay.remove();
    open3DViewer(repo, compare);
  });
}

// --------------------------------------------------------------------------
// 3D Viewer ‚Äî Professional with OrbitControls
// --------------------------------------------------------------------------
function open3DViewer(repo, commit) {
  if (!commit || !commit.layers.length) {
    toast('No layers to display in 3D');
    return;
  }

  if (typeof THREE === 'undefined') {
    toast('3D library not loaded');
    return;
  }

  const overlay = document.createElement('div');
  overlay.className = 'overlay';
  overlay.innerHTML = `
    <div class="card-dark" style="width:95%; height:95%; display:flex; flex-direction:column;">
      <div class="p-5 d-flex flex-justify-between flex-items-center border-bottom border-gray-dark">
        <h2>3D Stratigraphy Viewer ‚Äî ${escapeHTML(repo.name)}</h2>
        <div class="d-flex gap-4">
          <div class="small muted">Commit: ${escapeHTML(commit.message)} (${commit.year})</div>
          <button id="3d-close" class="btn btn-ghost btn-lg">Close</button>
        </div>
      </div>
      <div id="3d-container" style="flex:1; position:relative;">
        <canvas id="3d-canvas"></canvas>
      </div>
    </div>
  `;
  document.body.appendChild(overlay);

  overlay.querySelector('#3d-close').addEventListener('click', () => overlay.remove());

  const container = document.getElementById('3d-container');
  const canvas = document.getElementById('3d-canvas');

  const scene = new THREE.Scene();
  scene.background = new THREE.Color(0x0d1117);

  const camera = new THREE.PerspectiveCamera(60, container.clientWidth / container.clientHeight, 0.1, 1000);
  camera.position.set(200, 300, 400);

  const renderer = new THREE.WebGLRenderer({ canvas, antialias: true });
  renderer.setSize(container.clientWidth, container.clientHeight);

  const controls = new THREE.OrbitControls(camera, renderer.domElement);
  controls.enableDamping = true;
  controls.dampingFactor = 0.05;

  // Lighting
  const ambient = new THREE.AmbientLight(0xffffff, 0.6);
  scene.add(ambient);
  const dirLight = new THREE.DirectionalLight(0xffffff, 1);
  dirLight.position.set(200, 400, 200);
  scene.add(dirLight);

  // Ground plane
  const ground = new THREE.Mesh(
    new THREE.PlaneGeometry(600, 600),
    new THREE.MeshStandardMaterial({ color: 0x2d3743 })
  );
  ground.rotation.x = -Math.PI / 2;
  ground.position.y = -10;
  scene.add(ground);

  // Stratigraphy layers
  let yOffset = 0;
  commit.layers.forEach(layer => {
    const height = layer.thickness / 2;
    const geometry = new THREE.BoxGeometry(400, layer.thickness, 300);
    const material = new THREE.MeshStandardMaterial({
      color: layer.color || 0x8b949e,
      roughness: 0.8,
      metalness: 0.1
    });
    const mesh = new THREE.Mesh(geometry, material);
    mesh.position.y = yOffset + height;
    scene.add(mesh);

    // Label
    // Note: Three.js text would require additional loader, so we skip for single-file

    yOffset += layer.thickness;
  });

  // Animation loop
  function animate() {
    controls.update();
    renderer.render(scene, camera);
    requestAnimationFrame(animate);
  }
  animate();

  // Resize handler
  window.addEventListener('resize', () => {
    camera.aspect = container.clientWidth / container.clientHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(container.clientWidth, container.clientHeight);
  });
}

// --------------------------------------------------------------------------
// Export functions
// --------------------------------------------------------------------------
function exportRepoCSV(repo) {
  let csv = 'Year,Type,Author,Message,Layers\n';
  repo.commits.forEach(c => {
    const layers = c.layers.map(l => `${l.name}(${l.thickness}cm)`).join(';');
    csv += `${c.year},${c.type},${c.author},"${c.message.replace(/"/g, '""')}","${layers}"\n`;
  });

  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `${repo.name.replace(/[^a-z0-9]/gi, '_')}_commits.csv`;
  a.click();
  toast('CSV exported!');
}

function exportRepoJSON(repo) {
  const data = JSON.stringify(repo, null, 2);
  const blob = new Blob([data], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `${repo.name.replace(/[^a-z0-9]/gi, '_')}.json`;
  a.click();
  toast('JSON exported!');
}

// --------------------------------------------------------------------------
// Issues board (Kanban style)
// --------------------------------------------------------------------------
function renderIssuesBoard(root) {
  const columns = ['todo', 'inprogress', 'done'];
  root.innerHTML = `
    <div class="Box">
      <div class="Box-title">
        <div class="d-flex flex-justify-between">
          <h3>Issues Board</h3>
          <button id="new-global-issue" class="btn btn-primary">New Issue</button>
        </div>
      </div>
      <div class="Box-body p-5">
        <div class="d-flex gap-6">
          ${columns.map(col => `
            <div class="Box" style="flex:1; min-height:600px;">
              <div class="p-4 f5 text-bold text-uppercase">${col}</div>
              <div id="col-${col}" class="p-4"></div>
            </div>
          `).join('')}
        </div>
      </div>
    </div>
  `;

  function refreshBoard() {
    columns.forEach(col => {
      const container = document.getElementById(`col-${col}`);
      container.innerHTML = '';
      App.issues.filter(i => i.status === col).forEach(issue => {
        const card = document.createElement('div');
        card.className = 'Box mb-4 p-4';
        card.innerHTML = `
          <div class="f5 mb-2">${escapeHTML(issue.title)}</div>
          <div class="small muted mb-3">${issue.author}</div>
          <div class="d-flex gap-3">
            <button class="btn btn-sm btn-ghost btn-move" data-id="${issue.id}" data-dir="next">‚Üí Move</button>
            <button class="btn btn-sm btn-ghost btn-delete-issue" data-id="${issue.id}">Delete</button>
          </div>
        `;
        container.appendChild(card);
      });
    });

    document.querySelectorAll('.btn-move').forEach(btn => {
      btn.addEventListener('click', () => {
        const id = btn.dataset.id;
        const issue = App.issues.find(i => i.id === id);
        if (issue) {
          const currentIndex = columns.indexOf(issue.status);
          issue.status = columns[(currentIndex + 1) % columns.length];
          saveLS('archeo_issues', App.issues);
          refreshBoard();
        }
      });
    });

    document.querySelectorAll('.btn-delete-issue').forEach(btn => {
      btn.addEventListener('click', () => deleteIssue(btn.dataset.id));
    });
  }

  safeOn('#new-global-issue', 'click', () => {
    const title = prompt('Issue title:');
    if (!title) return;
    const issue = {
      id: uid('iss'),
      title,
      repoId: App.repos[0].id,
      status: 'todo',
      author: App.user ? App.user.displayName : 'guest',
      created: now(),
      comments: []
    };
    App.issues.push(issue);
    saveLS('archeo_issues', App.issues);
    refreshBoard();
    toast('Issue created');
  });

  refreshBoard();
}

// --------------------------------------------------------------------------
// Pull Requests list
// --------------------------------------------------------------------------
function renderPRList(root) {
  root.innerHTML = `
    <div class="Box">
      <div class="Box-title">
        <div class="d-flex flex-justify-between">
          <h3>Pull Requests</h3>
          <button id="new-global-pr" class="btn btn-primary">New PR</button>
        </div>
      </div>
      <div id="pr-list" class="Box-body p-5"></div>
    </div>
  `;

  function refresh() {
    const list = document.getElementById('pr-list');
    list.innerHTML = App.prs.map(pr => `
      <div class="Box mb-5">
        <div class="p-5">
          <div class="d-flex flex-justify-between">
            <div>
              <div class="f4 mb-2">${escapeHTML(pr.title)}</div>
              <div class="small muted">${pr.author} ‚Ä¢ ${pr.status}</div>
            </div>
            <div class="d-flex gap-3">
              <button class="btn btn-primary btn-sm btn-merge-global" data-id="${pr.id}">Merge</button>
              <button class="btn btn-ghost btn-sm btn-delete-pr-global" data-id="${pr.id}">Delete</button>
            </div>
          </div>
        </div>
      </div>
    `).join('') || '<p class="muted text-center">No pull requests yet</p>';

    document.querySelectorAll('.btn-merge-global').forEach(btn => {
      btn.addEventListener('click', () => {
        const pr = App.prs.find(p => p.id === btn.dataset.id);
        const repo = App.repos.find(r => r.id === pr.repoId);
        mergePR(pr.id, repo);
      });
    });

    document.querySelectorAll('.btn-delete-pr-global').forEach(btn => {
      btn.addEventListener('click', () => deletePR(btn.dataset.id));
    });
  }

  safeOn('#new-global-pr', 'click', () => {
    const title = prompt('PR title:');
    if (!title) return;
    const pr = {
      id: uid('pr'),
      title,
      repoId: App.repos[0].id,
      author: App.user ? App.user.displayName : 'guest',
      created: now(),
      status: 'open'
    };
    App.prs.push(pr);
    saveLS('archeo_prs', App.prs);
    refresh();
    toast('PR created');
  });

  refresh();
}

// --------------------------------------------------------------------------
// Profile page with contribution calendar
// --------------------------------------------------------------------------
function renderProfile(root) {
  if (!App.user) {
    document.getElementById('auth-modal').hidden = false;
    return;
  }

  const userCommits = [];
  App.repos.forEach(repo => {
    repo.commits.forEach(c => {
      if (c.author === App.user.displayName) userCommits.push({ repo, commit: c });
    });
  });

  userCommits.sort((a, b) => b.commit.year - a.commit.year);

  root.innerHTML = `
    <div class="Box mb-8 p-6">
      <div class="d-flex flex-items-center gap-8">
        <img src="${document.getElementById('avatar-img').src}" width="160" height="160" style="border-radius:20px;" />
        <div style="flex:1;">
          <h1 class="f00-light mb-3">${escapeHTML(App.user.displayName)}</h1>
          <p class="f3 muted mb-4">${escapeHTML(App.user.email)}</p>
          <div class="d-flex gap-8">
            <div>
              <div class="f2">${userCommits.length}</div>
              <div class="small muted">Contributions</div>
            </div>
            <div>
              <div class="f2">${App.repos.filter(r => r.owner === App.user.displayName).length}</div>
              <div class="small muted">Repositories added</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="two-col">
      <div>
        <div class="Box mb-6">
          <div class="Box-title">Your Contribution Calendar</div>
          <div class="Box-body p-6">
            <div id="contrib-chart" style="height:200px;"></div>
          </div>
        </div>

        <div class="Box">
          <div class="Box-title">Recent Activity</div>
          <div class="Box-body">
            ${userCommits.slice(0, 12).map(item => `
              <div class="Box-row">
                <div>
                  <div class="f5">${escapeHTML(item.commit.message)}</div>
                  <div class="small muted">${escapeHTML(item.repo.name)} ‚Ä¢ ${item.commit.year}</div>
                </div>
              </div>
            `).join('') || '<p class="muted p-5 text-center">No contributions yet</p>'}
          </div>
        </div>
      </div>
      <aside>
        <div class="Box mb-6">
          <div class="Box-title">Quick Actions</div>
          <div class="Box-body">
            <button class="btn btn-primary w-100 mb-4 btn-lg" onclick="document.getElementById('new-finding-modal').hidden = false">+ New Finding</button>
            <button class="btn btn-ghost w-100 btn-lg" onclick="navigate('issues')">View Issues Board</button>
          </div>
        </div>
      </aside>
    </div>
  `;

  // Contribution chart
  const ctx = document.getElementById('contrib-chart');
  if (typeof Chart !== 'undefined') {
    const years = userCommits.map(c => c.commit.year);
    const data = {};
    years.forEach(y => data[y] = (data[y] || 0) + 1);

    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: Object.keys(data).sort(),
        datasets: [{
          label: 'Commits per year',
          data: Object.values(data),
          backgroundColor: '#238636'
        }]
      },
      options: {
        responsive: true,
        scales: {
          y: { beginAtZero: true }
        }
      }
    });
  }
}

// --------------------------------------------------------------------------
// Header navigation wiring
// --------------------------------------------------------------------------
function attachHeaderLinks() {
  document.querySelectorAll('[data-route]').forEach(link => {
    link.addEventListener('click', e => {
      e.preventDefault();
      const route = link.dataset.route;
      if (route === 'repo' && link.dataset.repo) {
        navigate('repo', { repoId: link.dataset.repo });
      } else {
        navigate(route);
      }
    });
  });
}

// --------------------------------------------------------------------------
// Initial boot
// --------------------------------------------------------------------------
updateHeaderAuth();
attachHeaderLinks();
(function init() {
  const hash = window.location.hash.slice(1);
  if (hash) {
    const parts = hash.split('-');
    App.page = parts[0] || 'explore';
    App.currentRepoId = parts[1] || null;
  }
  render();
})();
</script>
</body>
</html>
